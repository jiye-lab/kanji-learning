<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>æ—¥æ–‡æ±‰å­—å‘éŸ³å­¦ä¹ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 6px;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        .header {
            margin-bottom: 6px;
        }

        .title {
            font-size: 1.6em;
            color: #333;
            margin-bottom: 2px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 0;
        }

        .game-area {
            margin-bottom: 6px;
        }

        .kanji-display {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin: 3px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .question {
            font-size: 1em;
            color: #555;
            margin-bottom: 10px;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .option-btn {
            padding: 6px 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
        }

        .option-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .option-btn:active {
            transform: scale(0.95);
        }

        .option-btn.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .option-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 6px;
            justify-content: center;
            max-width: 350px;
            margin: 0 auto;
        }

        .navigation-buttons {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-bottom: 6px;
        }

        .navigation-buttons .btn {
            flex: 1;
            max-width: 110px;
            font-size: 0.75em;
            padding: 4px 6px;
            min-height: 28px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .btn {
            padding: 4px 8px;
            font-size: 0.8em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: 600;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
            min-height: 28px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.4);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(116, 185, 255, 0.6);
        }

        .result-message {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }

        .result-correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result-incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            font-size: 1.2em;
            color: #666;
            margin: 40px 0;
        }

        .kanji-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 6px;
            margin: 8px auto;
            text-align: left;
            width: 100%;
            max-width: 400px;
        }

        .kanji-info h3 {
            color: #333;
            margin-bottom: 6px;
            font-size: 1.1em;
        }

        .reading-type {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-right: 10px;
        }

        .examples {
            margin-top: 3px;
            color: #666;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            margin: 15px 0;
            padding: 0 20px;
        }

        .progress-bar-wrapper {
            background: #f0f0f0;
            border-radius: 20px;
            height: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .progress-percentage {
            font-weight: 700;
            color: #667eea;
            font-size: 1.1em;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 8px;
                border-radius: 15px;
                max-width: 100%;
            }

            .title {
                font-size: 1.6em;
            }

            .subtitle {
                font-size: 0.8em;
            }

            .kanji-display {
                font-size: 32px;
                min-height: 30px;
                margin: 2px 0;
            }

            .question {
                font-size: 0.85em;
            }

            .options {
                grid-template-columns: 1fr;
                gap: 6px;
            }

            .option-btn {
                padding: 8px 10px;
                font-size: 0.9em;
                min-height: 38px;
                border-radius: 8px;
            }

            .stats {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .controls {
                flex-direction: column;
                gap: 6px;
            }

            .navigation-buttons {
                display: flex;
                gap: 6px;
                justify-content: space-between;
                margin-bottom: 6px;
            }

            .navigation-buttons .btn {
                flex: 1;
                max-width: 100px;
                font-size: 0.75em;
                padding: 3px 6px;
                min-height: 20px;
            }

            .action-buttons {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .action-buttons .btn {
                padding: 3px 6px;
                font-size: 0.75em;
                min-height: 20px;
            }

            .btn {
                padding: 3px 6px;
                font-size: 0.75em;
                min-height: 20px;
                border-radius: 4px;
            }

            .search-container input {
                width: 100%;
                max-width: 300px;
                padding: 12px 15px;
                font-size: 1.1em;
            }

            .search-container button {
                padding: 12px 18px;
                font-size: 1em;
            }

            .kanji-info {
                padding: 8px;
                font-size: 0.95em;
            }
        }

        /* å°å±æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 480px) {
            .container {
                padding: 4px;
            }

            .title {
                font-size: 1.6em;
            }

            .kanji-display {
                font-size: 32px;
            }

            .option-btn {
                padding: 10px 10px;
                font-size: 0.85em;
            }

            .btn {
                padding: 3px 6px;
                font-size: 0.75em;
                min-height: 20px;
            }

            .navigation-buttons .btn {
                padding: 3px 6px;
                font-size: 0.75em;
                min-height: 20px;
            }

            .action-buttons .btn {
                padding: 3px 6px;
                font-size: 0.75em;
                min-height: 20px;
            }
        }

        /* å¹³æ¿ä¼˜åŒ– */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 90%;
                padding: 35px;
            }

            .options {
                grid-template-columns: repeat(2, 1fr);
                gap: 18px;
            }

            .option-btn {
                padding: 16px 20px;
                font-size: 1.15em;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .option-btn {
                min-height: 60px;
                padding: 18px 15px;
            }

            .btn {
                min-height: 28px;
                padding: 8px 12px;
            }

            .navigation-buttons .btn {
                min-height: 28px;
                padding: 8px 12px;
                font-size: 0.75em;
            }

            .action-buttons .btn {
                min-height: 28px;
                padding: 8px 12px;
                font-size: 0.75em;
            }

            .option-btn:hover {
                transform: none;
            }

            .btn:hover {
                transform: none;
            }
        }

        /* æ¨ªå±æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 768px) and (orientation: landscape) {
            .kanji-display {
                font-size: 32px;
                margin: 15px 0;
            }

            .container {
                padding: 15px;
            }

            .stats {
                flex-direction: row;
                padding: 10px;
            }

            .controls {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
            }
        }

        /* è™šæ‹Ÿé”®ç›˜æ ·å¼ */
        .virtual-keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
            padding: 15px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .virtual-keyboard.show {
            transform: translateY(0);
        }

        .keyboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .keyboard-title {
            font-size: 1em;
            font-weight: 600;
            color: #495057;
        }

        .keyboard-close {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9em;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .keyboard-close:active {
            transform: scale(0.95);
        }

        .keyboard-rows {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 6px;
        }

        .keyboard-key {
            background: white;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 12px 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 32px;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            flex: 1;
        }

        .keyboard-key:active {
            background: #e9ecef;
            transform: scale(0.95);
        }

        /* åŠŸèƒ½è¡Œå¸ƒå±€ä¼˜åŒ– */
        .keyboard-row-function {
            justify-content: center;
            gap: 8px;
        }

        .keyboard-row-function .backspace-key {
            flex: 1;
            min-width: 80px;
        }

        .keyboard-row-function .submit-key {
            flex: 2;
            min-width: 160px;
        }

        .keyboard-key.function-key {
            background: #6c757d;
            color: white;
            font-size: 0.9em;
            min-width: 60px;
        }

        .keyboard-key.function-key:active {
            background: #5a6268;
        }

        .keyboard-key.space-key {
            flex: 1;
            max-width: 200px;
        }

        .keyboard-key.submit-key {
            background: #28a745;
            color: white;
            font-weight: 600;
            min-width: 80px;
            flex: 1;
            margin: 0 15px;
        }

        .keyboard-key.submit-key:active {
            background: #218838;
        }

        .keyboard-key.backspace-key {
            background: #dc3545;
            color: white;
            font-weight: 600;
            min-width: 80px;
        }

        .keyboard-key.backspace-key:active {
            background: #c82333;
        }

        .romaji-preview {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 0.9em;
            color: #1565c0;
        }

        /* ç§»åŠ¨ç«¯é”®ç›˜ä¼˜åŒ– */
        @media (max-width: 768px) {
            .virtual-keyboard {
                padding: 10px;
            }

            .keyboard-key {
                padding: 14px 6px;
                font-size: 0.95em;
                min-width: 28px;
            }

            .keyboard-row {
                gap: 4px;
            }

            .keyboard-row-function .backspace-key {
                flex: 1;
                min-width: 60px;
                font-size: 1.1em;
            }
            
            .keyboard-row-function .submit-key {
                flex: 2;
                min-width: 120px;
                font-size: 1.1em;
            }
        }

        @media (max-width: 480px) {
            .keyboard-key {
                padding: 16px 4px;
                font-size: 0.9em;
                min-width: 24px;
            }

            .keyboard-row {
                gap: 3px;
            }

            .keyboard-row-function .backspace-key {
                flex: 1;
                min-width: 50px;
                font-size: 1em;
            }
            
            .keyboard-row-function .submit-key {
                flex: 2;
                min-width: 100px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">æ—¥æ–‡æ±‰å­—å‘éŸ³å­¦ä¹ </h1>
            <p class="subtitle">å­¦ä¹ æ—¥æ–‡æ±‰å­—çš„éŸ³è¯»å’Œè®­è¯»å‘éŸ³</p>
        </div>

        <div class="game-area">
            <div class="loading" id="loading">æ­£åœ¨åŠ è½½æ±‰å­—æ•°æ®...</div>
            
            <div id="game-content" style="display: none;">
                <div class="kanji-display" id="kanji-display">æ¼¢</div>
                <div class="question" id="question">è¯·é€‰æ‹©è¿™ä¸ªæ±‰å­—çš„æ­£ç¡®å‘éŸ³ï¼š</div>
                
                <div class="options" id="options">
                    <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="result-message" id="result-message" style="display: none;"></div>

                <div class="kanji-info" id="kanji-info" style="display: none;">
                    <!-- æ±‰å­—è¯¦ç»†ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="navigation-buttons">
                <!-- å¯¼èˆªæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
            <div class="action-buttons" style="margin-top: 15px; text-align: center;">
                <button class="btn btn-primary" id="search-btn" onclick="toggleSearch()">æœç´¢</button>
                <button class="btn btn-secondary" id="mode-btn" onclick="toggleMode()">åˆ‡æ¢æ¨¡å¼</button>
            </div>
            <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display: none;">ä¸‹ä¸€é¢˜</button>
            <button class="btn btn-secondary" id="show-info-btn" onclick="toggleKanjiInfo()" style="display: none;">æ˜¾ç¤ºè¯¦æƒ…</button>
        </div>
        
        <div class="search-container" id="search-container" style="margin-top: 15px; text-align: center; display: none;">
            <div style="display: inline-flex; align-items: center; gap: 6px; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 400px;">
                <input type="text" id="search-input" placeholder="æœç´¢æ±‰å­—ã€è¯»éŸ³æˆ–å«ä¹‰..." 
                       style="padding: 6px 12px; font-size: 0.9em; border: 2px solid #ddd; border-radius: 20px; 
                              flex: 1; min-width: 200px; outline: none; transition: all 0.3s;" 
                       onkeypress="handleSearchKeyPress(event)">
                <button class="btn btn-primary" onclick="searchKanji()" 
                        style="padding: 6px 12px; border-radius: 20px; font-size: 0.9em; min-width: 40px;">ğŸ”</button>
            </div>
            <div id="search-results" style="margin-top: 10px; max-height: 150px; overflow-y: auto; display: none;"></div>
        </div>

        <div id="mode-info" class="mode-info" style="margin-top: 15px; padding: 8px; background: #e3f2fd; border-radius: 8px; font-size: 0.85em; color: #1565c0;">
             å½“å‰æ¨¡å¼ï¼šå­¦ä¹ æ¨¡å¼
         </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let kanjiData = [];
        let currentKanji = null;
        let currentOptions = [];
        let correctAnswer = '';
        let gameStats = {
            correct: 0,
            total: 0
        };
        let answered = false;
        let gameMode = 'study'; // 'study', 'example', 'input', 'plan'
        
        // æœ‰é™ç»ƒä¹ æ¨¡å¼çš„é¢˜åº“ç®¡ç†
        let remainingKanji = []; // æœªç­”å¯¹çš„æ±‰å­—ï¼ˆåŒ…æ‹¬æ–°é¢˜å’Œé”™é¢˜ï¼‰
        let completedKanji = []; // å·²ç­”å¯¹çš„æ±‰å­—
        let isFiniteMode = false; // æ˜¯å¦ä¸ºæœ‰é™ç»ƒä¹ æ¨¡å¼
        let isFirstQuestion = true; // æ˜¯å¦ä¸ºç¬¬ä¸€æ¬¡è¿›å…¥æ¨¡å¼çš„ç¬¬ä¸€é¢˜
        
        let studyPlan = {
            learnedWords: [], // å·²å­¦ä¹ çš„è¯æ±‡
            reviewSchedule: [], // å¤ä¹ è®¡åˆ’
            currentDay: 0, // å½“å‰å­¦ä¹ å¤©æ•°
            studyIndex: 0 // å­¦ä¹ è¿›åº¦ç´¢å¼•
        };
        let currentExample = null;
        let currentExampleKanji = null;
        let exampleQuestions = [];
        let studyIndex = 0;

        // åˆ‡æ¢æ¸¸æˆæ¨¡å¼
        function toggleMode() {
            // æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©å¯¹è¯æ¡†
            showModeSelector();
        }

        // æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©å™¨
        function showModeSelector() {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 24px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                text-align: center;
            `;
            
            modal.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 1.2em;">é€‰æ‹©å­¦ä¹ æ¨¡å¼</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="mode-option" data-mode="study" style="
                        padding: 12px 16px;
                        border: 2px solid #667eea;
                        border-radius: 8px;
                        background: ${gameMode === 'study' ? '#667eea' : 'white'};
                        color: ${gameMode === 'study' ? 'white' : '#667eea'};
                        cursor: pointer;
                        font-size: 1em;
                        transition: all 0.3s;
                    ">
                        ğŸ“š å­¦ä¹ æ¨¡å¼ - æµè§ˆæ±‰å­—å‘éŸ³å’Œä¾‹è¯
                    </button>
                    <button class="mode-option" data-mode="example" style="
                        padding: 12px 16px;
                        border: 2px solid #28a745;
                        border-radius: 8px;
                        background: ${gameMode === 'example' ? '#28a745' : 'white'};
                        color: ${gameMode === 'example' ? 'white' : '#28a745'};
                        cursor: pointer;
                        font-size: 1em;
                        transition: all 0.3s;
                    ">
                        ğŸ¯ å¤ä¹ æµ‹è¯• - æ ¹æ®ä¾‹è¯é€‰æ‹©æ­£ç¡®å‘éŸ³
                    </button>
                    <button class="mode-option" data-mode="input" style="
                        padding: 12px 16px;
                        border: 2px solid #ffc107;
                        border-radius: 8px;
                        background: ${gameMode === 'input' ? '#ffc107' : 'white'};
                        color: ${gameMode === 'input' ? 'white' : '#ffc107'};
                        cursor: pointer;
                        font-size: 1em;
                        transition: all 0.3s;
                    ">
                        âœï¸ æ‰‹åŠ¨è¾“å…¥ - æ ¹æ®ä¾‹è¯æ‰‹åŠ¨è¾“å…¥å‘éŸ³
                    </button>
                    <button class="mode-option" data-mode="plan" style="
                        padding: 12px 16px;
                        border: 2px solid #6f42c1;
                        border-radius: 8px;
                        background: ${gameMode === 'plan' ? '#6f42c1' : 'white'};
                        color: ${gameMode === 'plan' ? 'white' : '#6f42c1'};
                        cursor: pointer;
                        font-size: 1em;
                        transition: all 0.3s;
                    ">
                        ğŸ“‹ å­¦ä¹ è®¡åˆ’ - åˆ¶å®šå­¦ä¹ ç›®æ ‡å’Œå¤ä¹ è®¡åˆ’
                    </button>
                </div>
                <button onclick="closeModeSelector()" style="
                    margin-top: 16px;
                    padding: 8px 16px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    background: #f8f9fa;
                    color: #666;
                    cursor: pointer;
                    font-size: 0.9em;
                ">å–æ¶ˆ</button>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            modal.querySelectorAll('.mode-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    const selectedMode = btn.dataset.mode;
                    switchToMode(selectedMode);
                    closeModeSelector();
                });
                
                // æ‚¬åœæ•ˆæœ
                btn.addEventListener('mouseenter', () => {
                    if (btn.dataset.mode !== gameMode) {
                        btn.style.opacity = '0.8';
                    }
                });
                
                btn.addEventListener('mouseleave', () => {
                    btn.style.opacity = '1';
                });
            });
            
            // ç‚¹å‡»é®ç½©å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeModeSelector();
                }
            });
            
            // å­˜å‚¨å¼•ç”¨ä»¥ä¾¿å…³é—­
            window.currentModeSelector = overlay;
        }

        // å…³é—­æ¨¡å¼é€‰æ‹©å™¨
        function closeModeSelector() {
            if (window.currentModeSelector) {
                document.body.removeChild(window.currentModeSelector);
                window.currentModeSelector = null;
            }
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šæ¨¡å¼
        function switchToMode(mode) {
            gameMode = mode;
            
            // é‡ç½®ç¬¬ä¸€é¢˜æ ‡å¿—
            isFirstQuestion = true;
            
            // å¦‚æœåˆ‡æ¢åˆ°ç»ƒä¹ æ¨¡å¼ï¼Œåˆå§‹åŒ–æœ‰é™æ¨¡å¼
            if (gameMode === 'example' || gameMode === 'input') {
                initFiniteMode();
            } else {
                isFiniteMode = false;
            }
            
            updateModeInfo();
            if (gameMode === 'study') {
                enhancedShowStudyMode();
            } else if (gameMode === 'example') {
                nextQuestion();
            } else if (gameMode === 'input') {
                nextQuestion();
            } else {
                showPlanMode();
            }
        }

        // åˆå§‹åŒ–æœ‰é™ç»ƒä¹ æ¨¡å¼
        function initFiniteMode() {
            isFiniteMode = true;
            
            // è·å–å·²å­¦ä¹ çš„æ±‰å­—
            const learnedKanji = studyPlan.learnedWords.map(item => item.kanji);
            
            // è·å–æ‰€æœ‰å·²å­¦æ±‰å­—çš„ä¾‹è¯ï¼ˆæŒ‰å‘éŸ³åˆ†ç»„ï¼‰
            const learnedExamples = exampleQuestions.filter(q => learnedKanji.includes(q.kanji));
            
            // æŒ‰å‘éŸ³åˆ†ç»„ï¼Œæ¯ä¸ªå‘éŸ³åªé€‰ä¸€ä¸ªä¾‹è¯
            const readingGroups = new Map();
            learnedExamples.forEach(example => {
                const key = `${example.kanji}-${example.reading}-${example.type}`;
                if (!readingGroups.has(key)) {
                    readingGroups.set(key, []);
                }
                readingGroups.get(key).push(example);
            });
            
            // ä»æ¯ä¸ªå‘éŸ³ç»„ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªä¾‹è¯
            const selectedExamples = [];
            readingGroups.forEach(examples => {
                const randomIndex = Math.floor(Math.random() * examples.length);
                selectedExamples.push(examples[randomIndex]);
            });
            
            // åˆå§‹åŒ–é¢˜åº“ï¼šæ¯ä¸ªå‘éŸ³åªæœ‰ä¸€é“é¢˜ç›®
            remainingKanji = [...selectedExamples];
            completedKanji = [];
            
            console.log(`æœ‰é™ç»ƒä¹ æ¨¡å¼å·²åˆå§‹åŒ–ï¼Œå…± ${remainingKanji.length} é“é¢˜ç›®`);
        }

        // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰é¢˜ç›®
        function checkFiniteCompletion() {
            if (isFiniteMode && remainingKanji.length === 0) {
                showCompletionScreen();
                return true;
            }
            return false;
        }

        // æ˜¾ç¤ºå®Œæˆç•Œé¢
        function showCompletionScreen() {
            document.getElementById('kanji-display').innerHTML = 'ğŸ‰';
            document.getElementById('kanji-display').style.fontSize = '64px';
            document.getElementById('question').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h2 style="color: #28a745; margin-bottom: 16px;">æ­å–œå®Œæˆï¼</h2>
                    <p style="font-size: 18px; margin-bottom: 12px;">ä½ å·²ç»å®Œæˆäº†æ‰€æœ‰ ${completedKanji.length} é“é¢˜ç›®ï¼</p>
                    <p style="color: #666; margin-bottom: 20px;">æ‰€æœ‰æ±‰å­—éƒ½ç­”å¯¹äº†ï¼Œå¤ªæ£’äº†ï¼</p>
                    <button onclick="restartFiniteMode()" class="btn btn-primary" style="margin-right: 10px;">é‡æ–°å¼€å§‹</button>
                    <button onclick="switchToMode('study')" class="btn btn-secondary">è¿”å›å­¦ä¹ æ¨¡å¼</button>
                </div>
            `;
            document.getElementById('options').innerHTML = '';
            document.getElementById('result-message').style.display = 'none';
            document.getElementById('kanji-info').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('show-info-btn').style.display = 'none';
            document.getElementById('search-btn').style.display = 'none';
            document.getElementById('mode-btn').style.display = 'inline-block';
            
            // æ¸…ç©ºå¯¼èˆªæŒ‰é’®
            const navigationButtons = document.querySelector('.navigation-buttons');
            navigationButtons.innerHTML = '';
        }

        // é‡æ–°å¼€å§‹æœ‰é™ç»ƒä¹ æ¨¡å¼
        function restartFiniteMode() {
            initFiniteMode();
            if (gameMode === 'example') {
                generateExampleQuestion();
            } else if (gameMode === 'input') {
                generateInputQuestion();
            }
        }

        // æ›´æ–°æ¨¡å¼ä¿¡æ¯æ˜¾ç¤º
        function updateModeInfo() {
            const modeInfo = document.getElementById('mode-info');
            if (gameMode === 'study') {
                modeInfo.innerHTML = '<strong>å½“å‰æ¨¡å¼ï¼š</strong>å­¦ä¹ æ¨¡å¼ - æµè§ˆæ±‰å­—å‘éŸ³å’Œä¾‹è¯';
            } else if (gameMode === 'example') {
                modeInfo.innerHTML = '<strong>å½“å‰æ¨¡å¼ï¼š</strong>å¤ä¹ æµ‹è¯• - æ ¹æ®ä¾‹è¯ä¸­çš„æ±‰å­—é€‰æ‹©æ­£ç¡®å‘éŸ³';
            } else if (gameMode === 'input') {
                modeInfo.innerHTML = '<strong>å½“å‰æ¨¡å¼ï¼š</strong>æ‰‹åŠ¨è¾“å…¥å¤ä¹  - æ ¹æ®ä¾‹è¯ä¸­çš„æ±‰å­—æ‰‹åŠ¨è¾“å…¥æ­£ç¡®å‘éŸ³';
            } else {
                modeInfo.innerHTML = '<strong>å½“å‰æ¨¡å¼ï¼š</strong>å­¦ä¹ è®¡åˆ’ - åˆ¶å®šæ¯æ—¥å­¦ä¹ ç›®æ ‡å’Œå¤ä¹ è®¡åˆ’';
            }
        }

        // å­¦ä¹ æ¨¡å¼æ˜¾ç¤º
        function showStudyMode() {
            if (kanjiData.length === 0) return;
            
            // é‡ç½®çŠ¶æ€
            document.getElementById('result-message').style.display = 'none';
            document.getElementById('kanji-info').style.display = 'none';
            document.getElementById('options').innerHTML = '';
            document.getElementById('question').textContent = 'å­¦ä¹ æ¨¡å¼ - æµè§ˆæ±‰å­—å‘éŸ³å’Œä¾‹è¯';
            
            // æ˜¾ç¤ºå½“å‰æ±‰å­—
            currentKanji = kanjiData[studyIndex];
            document.getElementById('kanji-display').textContent = currentKanji.kanji;
            document.getElementById('kanji-display').style.fontSize = '32px';
            
            // æ˜¾ç¤ºæ±‰å­—è¯¦ç»†ä¿¡æ¯
            showKanjiInfo();
            
            // æ˜¾ç¤ºå¯¼èˆªæŒ‰é’®
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('show-info-btn').style.display = 'none';
            document.getElementById('search-btn').style.display = 'inline-block';
            document.getElementById('mode-btn').style.display = 'inline-block';
            
            // æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºå¯¼èˆªæŒ‰é’®
            const navigationButtons = document.querySelector('.navigation-buttons');
            navigationButtons.innerHTML = '';
            
            // æ·»åŠ ä¸Šä¸€ä¸ªæ±‰å­—æŒ‰é’®
            const prevBtn = document.createElement('button');
            prevBtn.id = 'prev-btn';
            prevBtn.className = 'btn btn-secondary';
            prevBtn.textContent = 'ä¸Šä¸€ä¸ªæ±‰å­—';
            prevBtn.onclick = () => previousKanji();
            navigationButtons.appendChild(prevBtn);
            
            // æ·»åŠ "æ ‡è®°ä¸ºå·²å­¦"æŒ‰é’®åˆ°å¯¼èˆªæŒ‰é’®ä¸­é—´
            const currentKanjiChar = document.getElementById('kanji-display').textContent;
            const isLearned = studyPlan.learnedWords.find(item => item.kanji === currentKanjiChar);
            
            if (!isLearned) {
                const learnBtn = document.createElement('button');
                learnBtn.id = 'learn-btn';
                learnBtn.textContent = 'âœ“ æ ‡è®°ä¸ºå·²å­¦';
                learnBtn.className = 'btn';
                learnBtn.style.background = '#28a745';
                learnBtn.style.color = 'white';
                learnBtn.onclick = () => {
                    addToLearned(currentKanjiChar);
                    learnBtn.textContent = 'âœ“ å·²å­¦ä¹ ';
                    learnBtn.disabled = true;
                    learnBtn.style.background = '#6c757d';
                    // æ ‡è®°ä¸ºå·²å­¦åï¼Œè‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæœªå­¦æ±‰å­—
                    setTimeout(() => {
                        nextQuestion();
                    }, 500);
                };
                navigationButtons.appendChild(learnBtn);
            }
            
            // æ·»åŠ ä¸‹ä¸€ä¸ªæ±‰å­—æŒ‰é’®
            const nextBtn = document.createElement('button');
            nextBtn.id = 'next-kanji-btn';
            nextBtn.className = 'btn btn-primary';
            nextBtn.textContent = 'ä¸‹ä¸€ä¸ªæ±‰å­—';
            nextBtn.onclick = () => nextQuestion();
            navigationButtons.appendChild(nextBtn);
        }

        // ç”Ÿæˆæœ‰é™æ¨¡å¼çš„æ‰‹åŠ¨è¾“å…¥æµ‹è¯•é¢˜
        function generateFiniteInputQuestion() {
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™é¢˜ç›®
            if (remainingKanji.length === 0) {
                checkFiniteCompletion();
                return;
            }

            // é‡ç½®çŠ¶æ€
            resetQuestionState();

            // ä»å‰©ä½™ä¾‹è¯ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            const randomIndex = Math.floor(Math.random() * remainingKanji.length);
            currentExample = remainingKanji[randomIndex];
            currentKanji = currentExample.kanjiEntry;
            correctAnswer = currentExample.reading;

            // æ˜¾ç¤ºä¾‹è¯ï¼Œé«˜äº®ç›®æ ‡æ±‰å­—
            const highlightedExample = currentExample.example.replace(
                new RegExp(currentExample.kanji, 'g'), 
                `<span style="color: #667eea; font-weight: bold; text-decoration: underline;">${currentExample.kanji}</span>`
            );
            document.getElementById('kanji-display').innerHTML = highlightedExample;
            document.getElementById('kanji-display').style.fontSize = '32px';
            
            // æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
            const typeText = currentExample.type === 'on' ? 'éŸ³è¯»' : 'è®­è¯»';
            document.getElementById('question').innerHTML = `è¯·è¾“å…¥ä¾‹è¯"${currentExample.example}"ä¸­<strong>${currentExample.kanji}</strong>å­—çš„${typeText}å‘éŸ³ï¼š`;

            // æ·»åŠ è¿›åº¦æ¡
            const progressBarHtml = createProgressBar(completedKanji.length, completedKanji.length + remainingKanji.length);
            const progressContainer = document.createElement('div');
            progressContainer.innerHTML = progressBarHtml;
            document.getElementById('question').appendChild(progressContainer.firstElementChild);

            // ç”Ÿæˆè¾“å…¥ç•Œé¢
            generateInputInterface();
            
            // åˆ›å»ºå¯¼èˆªæŒ‰é’®
            const navigationButtons = document.querySelector('.navigation-buttons');
            navigationButtons.innerHTML = '';
            
            // æ·»åŠ ä¸Šä¸€é¢˜æŒ‰é’®
            const prevBtn = document.createElement('button');
            prevBtn.id = 'prev-input-btn';
            prevBtn.className = 'btn btn-secondary';
            prevBtn.textContent = 'ä¸Šä¸€é¢˜';
            prevBtn.onclick = () => generateFiniteInputQuestion();
            navigationButtons.appendChild(prevBtn);
            
            // æ·»åŠ æ˜¾ç¤ºè¯¦æƒ…æŒ‰é’®
            const infoBtn = document.createElement('button');
            infoBtn.id = 'show-info-input-btn';
            infoBtn.className = 'btn';
            infoBtn.style.background = '#17a2b8';
            infoBtn.style.color = 'white';
            infoBtn.textContent = 'æ˜¾ç¤ºè¯¦æƒ…';
            infoBtn.onclick = () => toggleKanjiInfo();
            navigationButtons.appendChild(infoBtn);
            
            // æ·»åŠ ä¸‹ä¸€é¢˜æŒ‰é’®
            const nextBtn = document.createElement('button');
            nextBtn.id = 'next-input-btn';
            nextBtn.className = 'btn btn-primary';
            nextBtn.textContent = 'ä¸‹ä¸€é¢˜';
            nextBtn.onclick = () => nextQuestion();
            navigationButtons.appendChild(nextBtn);
        }
        
        // ä¸Šä¸€ä¸ªæ±‰å­—
        function previousKanji() {
            if (gameMode !== 'study') return;
            studyIndex = (studyIndex - 1 + kanjiData.length) % kanjiData.length;
            studyPlan.studyIndex = studyIndex;
            savePlan();
            
            // ç›´æ¥æ˜¾ç¤ºæŒ‡å®šæ±‰å­—ï¼Œä¸è‡ªåŠ¨è·³è½¬åˆ°æœªå­¦æ±‰å­—
            showStudyMode();
            
            // ä¸ºå·²å­¦æ±‰å­—æ·»åŠ çŠ¶æ€æ˜¾ç¤º
            const kanjiInfo = document.getElementById('kanji-info');
            if (kanjiInfo && kanjiInfo.style.display !== 'none') {
                const currentKanjiChar = document.getElementById('kanji-display').textContent;
                const isLearned = studyPlan.learnedWords.find(item => item.kanji === currentKanjiChar);
                
                if (isLearned) {
                    const statusDiv = document.createElement('div');
                    statusDiv.innerHTML = '<span style="color: #28a745; font-weight: bold;">âœ“ å·²å­¦ä¹ </span>';
                    statusDiv.style.marginTop = '10px';
                    kanjiInfo.appendChild(statusDiv);
                }
                // ç§»é™¤è¿™é‡Œçš„æ ‡è®°ä¸ºå·²å­¦æŒ‰é’®ï¼Œå› ä¸ºå·²ç»ç§»åˆ°controlsåŒºåŸŸäº†
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ï¼ˆç§»é™¤é‡å¤çš„äº‹ä»¶ç›‘å¬å™¨ï¼‰

        // åŠ è½½æ±‰å­—æ•°æ®
        async function loadKanjiData() {
            try {
                const response = await fetch('kanji_data_enhanced_hiragana.json');
                kanjiData = await response.json();
                
                // é¢„å¤„ç†ä¾‹è¯æ•°æ®
                preprocessExampleData();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game-content').style.display = 'block';
                
                // åŠ è½½å­¦ä¹ è®¡åˆ’å¹¶å¯åŠ¨å­¦ä¹ æ¨¡å¼
                loadPlan();
                
                // é»˜è®¤å¯åŠ¨å­¦ä¹ æ¨¡å¼ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªæœªå­¦æ±‰å­—
                enhancedShowStudyMode();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('loading').textContent = 'åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨';
            }
        }

        // é¢„å¤„ç†ä¾‹è¯æ•°æ®
        function preprocessExampleData() {
            exampleQuestions = [];
            
            kanjiData.forEach(kanjiEntry => {
                kanjiEntry.readings.forEach(reading => {
                    if (reading.examples && reading.examples.length > 0) {
                        reading.examples.forEach(example => {
                            // æ£€æŸ¥ä¾‹è¯ä¸­æ˜¯å¦åŒ…å«å½“å‰æ±‰å­—
                            if (example.includes(kanjiEntry.kanji)) {
                                exampleQuestions.push({
                                    kanji: kanjiEntry.kanji,
                                    example: example,
                                    reading: reading.reading,
                                    type: reading.type,
                                    kanjiEntry: kanjiEntry
                                });
                            }
                        });
                    }
                });
            });
            
            console.log(`é¢„å¤„ç†å®Œæˆï¼Œå…±ç”Ÿæˆ ${exampleQuestions.length} ä¸ªä¾‹è¯é—®é¢˜`);
        }

        // ç”Ÿæˆä¸‹ä¸€é¢˜
        function nextQuestion() {
            // æ ‡è®°ä¸å†æ˜¯ç¬¬ä¸€é¢˜
            isFirstQuestion = false;
            
            if (gameMode === 'study') {
                studyIndex = (studyIndex + 1) % kanjiData.length;
                studyPlan.studyIndex = studyIndex;
                savePlan();
                
                // ç›´æ¥æ˜¾ç¤ºæŒ‡å®šæ±‰å­—ï¼Œä¸è‡ªåŠ¨è·³è½¬åˆ°æœªå­¦æ±‰å­—
                showStudyMode();
                
                // ä¸ºå·²å­¦æ±‰å­—æ·»åŠ çŠ¶æ€æ˜¾ç¤º
                const kanjiInfo = document.getElementById('kanji-info');
                if (kanjiInfo && kanjiInfo.style.display !== 'none') {
                    const currentKanjiChar = document.getElementById('kanji-display').textContent;
                    const isLearned = studyPlan.learnedWords.find(item => item.kanji === currentKanjiChar);
                    
                    if (isLearned) {
                        const statusDiv = document.createElement('div');
                        statusDiv.innerHTML = '<span style="color: #28a745; font-weight: bold;">âœ“ å·²å­¦ä¹ </span>';
                        statusDiv.style.marginTop = '10px';
                        kanjiInfo.appendChild(statusDiv);
                    }
                    // ç§»é™¤è¿™é‡Œçš„æ ‡è®°ä¸ºå·²å­¦æŒ‰é’®ï¼Œå› ä¸ºå·²ç»ç§»åˆ°controlsåŒºåŸŸäº†
                }
                return;
            }
            
            if (gameMode === 'input') {
                generateInputQuestion();
            } else {
                generateExampleQuestion();
            }
        }

        // ç”Ÿæˆæ±‰å­—å‘éŸ³æµ‹è¯•é¢˜
        function generateKanjiQuestion() {
            if (kanjiData.length === 0) return;

            // é‡ç½®çŠ¶æ€
            resetQuestionState();

            // éšæœºé€‰æ‹©ä¸€ä¸ªæ±‰å­—
            currentKanji = kanjiData[Math.floor(Math.random() * kanjiData.length)];
            
            // æ˜¾ç¤ºæ±‰å­—
            document.getElementById('kanji-display').textContent = currentKanji.kanji;
            document.getElementById('question').textContent = 'è¯·é€‰æ‹©è¿™ä¸ªæ±‰å­—çš„æ­£ç¡®å‘éŸ³ï¼š';

            // éšæœºé€‰æ‹©ä¸€ä¸ªè¯»éŸ³ä½œä¸ºæ­£ç¡®ç­”æ¡ˆ
            const readings = currentKanji.readings;
            const correctReading = readings[Math.floor(Math.random() * readings.length)];
            correctAnswer = correctReading.reading;

            // ç”Ÿæˆé€‰é¡¹ï¼ˆ1ä¸ªæ­£ç¡®ç­”æ¡ˆ + 3ä¸ªé”™è¯¯ç­”æ¡ˆï¼‰
            generateOptions(correctAnswer);
        }

        // ç”Ÿæˆä¾‹è¯æµ‹è¯•é¢˜ï¼ˆä»…å¤ä¹ å·²å­¦æ±‰å­—ï¼‰
        function generateExampleQuestion() {
            // å¦‚æœæ˜¯æœ‰é™æ¨¡å¼ï¼Œä½¿ç”¨æœ‰é™æ¨¡å¼é€»è¾‘
            if (isFiniteMode) {
                return generateFiniteExampleQuestion();
            }
            
            // åŸæœ‰çš„æ— é™æ¨¡å¼é€»è¾‘
            // ç­›é€‰å·²å­¦æ±‰å­—çš„ä¾‹è¯
            const learnedKanji = studyPlan.learnedWords.map(item => item.kanji);
            const learnedExamples = exampleQuestions.filter(q => learnedKanji.includes(q.kanji));
            
            if (learnedExamples.length === 0) {
                document.getElementById('kanji-display').textContent = 'ğŸ“š';
                document.getElementById('kanji-display').style.fontSize = '32px';
                document.getElementById('question').textContent = 'è¿˜æ²¡æœ‰å­¦ä¹ è¿‡çš„æ±‰å­—ï¼Œè¯·å…ˆåœ¨å­¦ä¹ æ¨¡å¼ä¸­å­¦ä¹ ä¸€äº›æ±‰å­—ï¼';
                document.getElementById('options').innerHTML = '';
                document.getElementById('result-message').style.display = 'none';
                document.getElementById('kanji-info').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('show-info-btn').style.display = 'none';
                document.getElementById('search-btn').style.display = 'inline-block';
                document.getElementById('mode-btn').style.display = 'inline-block';
                const prevBtn = document.getElementById('prev-btn');
                if (prevBtn) prevBtn.style.display = 'none';
                return;
            }

            // é‡ç½®çŠ¶æ€
            resetQuestionState();

            // ä¼˜å…ˆé€‰æ‹©ä»Šæ—¥éœ€è¦å¤ä¹ çš„æ±‰å­—
            const today = new Date().toDateString();
            const todayReview = studyPlan.reviewSchedule.filter(item => 
                new Date(item.reviewDate).toDateString() === today
            );
            
            let availableExamples = learnedExamples;
            if (todayReview.length > 0) {
                const todayKanji = todayReview.map(item => item.kanji);
                const todayExamples = learnedExamples.filter(q => todayKanji.includes(q.kanji));
                if (todayExamples.length > 0) {
                    availableExamples = todayExamples;
                }
            }

            // éšæœºé€‰æ‹©ä¸€ä¸ªä¾‹è¯é—®é¢˜
            currentExample = availableExamples[Math.floor(Math.random() * availableExamples.length)];
            currentKanji = currentExample.kanjiEntry;
            correctAnswer = currentExample.reading;

            // æ˜¾ç¤ºä¾‹è¯ï¼Œé«˜äº®ç›®æ ‡æ±‰å­—
            const highlightedExample = currentExample.example.replace(
                new RegExp(currentExample.kanji, 'g'), 
                `<span style="color: #667eea; font-weight: bold; text-decoration: underline;">${currentExample.kanji}</span>`
            );
            document.getElementById('kanji-display').innerHTML = highlightedExample;
            document.getElementById('kanji-display').style.fontSize = '32px';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šæ—¥å¤ä¹ ä»»åŠ¡
            const isReviewTask = todayReview.some(item => item.kanji === currentExample.kanji);
            const reviewText = isReviewTask ? ' ğŸ”„ (å¤ä¹ ä»»åŠ¡)' : '';
            const typeText = currentExample.type === 'on' ? 'éŸ³è¯»' : 'è®­è¯»';
            document.getElementById('question').innerHTML = `è¯·é€‰æ‹©ä¾‹è¯"${currentExample.example}"ä¸­<strong>${currentExample.kanji}</strong>å­—çš„${typeText}å‘éŸ³ï¼š${reviewText}`;

            // ç”Ÿæˆé€‰é¡¹
            generateExampleOptions(correctAnswer, currentExample.type);
            
            // åˆ›å»ºå¯¼èˆªæŒ‰é’®ï¼ˆä¸å­¦ä¹ æ¨¡å¼ä¿æŒä¸€è‡´çš„å¸ƒå±€ï¼‰
            const navigationButtons = document.querySelector('.navigation-buttons');
            navigationButtons.innerHTML = '';
            
            // æ·»åŠ ä¸Šä¸€é¢˜æŒ‰é’®
            const prevBtn = document.createElement('button');
            prevBtn.id = 'prev-question-btn';
            prevBtn.className = 'btn btn-secondary';
            prevBtn.textContent = 'ä¸Šä¸€é¢˜';
            prevBtn.onclick = () => generateExampleQuestion();
            navigationButtons.appendChild(prevBtn);
            
            // æ·»åŠ æ˜¾ç¤ºè¯¦æƒ…æŒ‰é’®
            const infoBtn = document.createElement('button');
            infoBtn.id = 'show-info-btn-nav';
            infoBtn.className = 'btn';
            infoBtn.style.background = '#17a2b8';
            infoBtn.style.color = 'white';
            infoBtn.textContent = 'æ˜¾ç¤ºè¯¦æƒ…';
            infoBtn.onclick = () => toggleKanjiInfo();
            navigationButtons.appendChild(infoBtn);
            
            // æ·»åŠ ä¸‹ä¸€é¢˜æŒ‰é’®
            const nextBtn = document.createElement('button');
            nextBtn.id = 'next-question-btn';
            nextBtn.className = 'btn btn-primary';
            nextBtn.textContent = 'ä¸‹ä¸€é¢˜';
            nextBtn.onclick = () => nextQuestion();
            navigationButtons.appendChild(nextBtn);
        }

        // ç”Ÿæˆè¿›åº¦æ¡HTML
        function createProgressBar(completed, total) {
            const percentage = Math.round((completed / total) * 100);
            return `
                <div class="progress-container">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" style="width: ${percentage}%"></div>
                    </div>
                    <div class="progress-text">
                        è¿›åº¦ï¼š<span class="progress-percentage">${percentage}%</span>
                    </div>
                </div>
            `;
        }

        // æœ‰é™æ¨¡å¼çš„å¤ä¹ æµ‹è¯•é¢˜ç”Ÿæˆ
        function generateFiniteExampleQuestion() {
            // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰é¢˜ç›®
            if (checkFiniteCompletion()) {
                return;
            }

            // ä»å‰©ä½™ä¾‹è¯ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
            const randomIndex = Math.floor(Math.random() * remainingKanji.length);
            currentExample = remainingKanji[randomIndex];
            currentKanji = currentExample.kanjiEntry;
            correctAnswer = currentExample.reading;

            // é‡ç½®çŠ¶æ€
            resetQuestionState();

            // æ˜¾ç¤ºä¾‹è¯ï¼Œé«˜äº®ç›®æ ‡æ±‰å­—
            const highlightedExample = currentExample.example.replace(
                new RegExp(currentExample.kanji, 'g'), 
                `<span style="color: #667eea; font-weight: bold; text-decoration: underline;">${currentExample.kanji}</span>`
            );
            document.getElementById('kanji-display').innerHTML = highlightedExample;
            document.getElementById('kanji-display').style.fontSize = '32px';
            
            const typeText = currentExample.type === 'on' ? 'éŸ³è¯»' : 'è®­è¯»';
            document.getElementById('question').innerHTML = `è¯·é€‰æ‹©ä¾‹è¯"${currentExample.example}"ä¸­<strong>${currentExample.kanji}</strong>å­—çš„${typeText}å‘éŸ³ï¼š`;

            // æ·»åŠ è¿›åº¦æ¡
            const progressBarHtml = createProgressBar(completedKanji.length, completedKanji.length + remainingKanji.length);
            const progressContainer = document.createElement('div');
            progressContainer.innerHTML = progressBarHtml;
            document.getElementById('question').appendChild(progressContainer.firstElementChild);

            // ç”Ÿæˆé€‰é¡¹
            generateExampleOptions(correctAnswer, currentExample.type);
            
            // åˆ›å»ºå¯¼èˆªæŒ‰é’®
            const navigationButtons = document.querySelector('.navigation-buttons');
            navigationButtons.innerHTML = '';
            

        }

        // ç”Ÿæˆæ‰‹åŠ¨è¾“å…¥æµ‹è¯•é¢˜ï¼ˆä»…å¤ä¹ å·²å­¦æ±‰å­—ï¼‰
        function generateInputQuestion() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰é™æ¨¡å¼
            if (isFiniteMode) {
                generateFiniteInputQuestion();
                return;
            }
            
            // ç­›é€‰å·²å­¦æ±‰å­—çš„ä¾‹è¯
            const learnedKanji = studyPlan.learnedWords.map(item => item.kanji);
            const learnedExamples = exampleQuestions.filter(q => learnedKanji.includes(q.kanji));
            
            if (learnedExamples.length === 0) {
                document.getElementById('kanji-display').textContent = 'ğŸ“š';
                document.getElementById('kanji-display').style.fontSize = '32px';
                document.getElementById('question').textContent = 'è¿˜æ²¡æœ‰å­¦ä¹ è¿‡çš„æ±‰å­—ï¼Œè¯·å…ˆåœ¨å­¦ä¹ æ¨¡å¼ä¸­å­¦ä¹ ä¸€äº›æ±‰å­—ï¼';
                document.getElementById('options').innerHTML = '';
                document.getElementById('result-message').style.display = 'none';
                document.getElementById('kanji-info').style.display = 'none';
                document.getElementById('next-btn').style.display = 'none';
                document.getElementById('show-info-btn').style.display = 'none';
                const prevBtn = document.getElementById('prev-btn');
                if (prevBtn) prevBtn.style.display = 'none';
                return;
            }

            // é‡ç½®çŠ¶æ€
            resetQuestionState();

            // ä¼˜å…ˆé€‰æ‹©ä»Šæ—¥éœ€è¦å¤ä¹ çš„æ±‰å­—
            const today = new Date().toDateString();
            const todayReview = studyPlan.reviewSchedule.filter(item => 
                new Date(item.reviewDate).toDateString() === today
            );
            
            let availableExamples = learnedExamples;
            if (todayReview.length > 0) {
                const todayKanji = todayReview.map(item => item.kanji);
                const todayExamples = learnedExamples.filter(q => todayKanji.includes(q.kanji));
                if (todayExamples.length > 0) {
                    availableExamples = todayExamples;
                }
            }

            // éšæœºé€‰æ‹©ä¸€ä¸ªä¾‹è¯é—®é¢˜
            currentExample = availableExamples[Math.floor(Math.random() * availableExamples.length)];
            currentKanji = currentExample.kanjiEntry;
            correctAnswer = currentExample.reading;

            // æ˜¾ç¤ºä¾‹è¯ï¼Œé«˜äº®ç›®æ ‡æ±‰å­—
            const highlightedExample = currentExample.example.replace(
                new RegExp(currentExample.kanji, 'g'), 
                `<span style="color: #667eea; font-weight: bold; text-decoration: underline;">${currentExample.kanji}</span>`
            );
            document.getElementById('kanji-display').innerHTML = highlightedExample;
            document.getElementById('kanji-display').style.fontSize = '32px';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šæ—¥å¤ä¹ ä»»åŠ¡
            const isReviewTask = todayReview.some(item => item.kanji === currentExample.kanji);
            const reviewText = isReviewTask ? ' ğŸ”„ (å¤ä¹ ä»»åŠ¡)' : '';
            const typeText = currentExample.type === 'on' ? 'éŸ³è¯»' : 'è®­è¯»';
            document.getElementById('question').innerHTML = `è¯·è¾“å…¥ä¾‹è¯"${currentExample.example}"ä¸­<strong>${currentExample.kanji}</strong>å­—çš„${typeText}å‘éŸ³ï¼š${reviewText}`;

            // ç”Ÿæˆè¾“å…¥ç•Œé¢
            generateInputInterface();
            
            // åˆ›å»ºå¯¼èˆªæŒ‰é’®ï¼ˆä¸å­¦ä¹ æ¨¡å¼ä¿æŒä¸€è‡´çš„å¸ƒå±€ï¼‰
            const navigationButtons = document.querySelector('.navigation-buttons');
            navigationButtons.innerHTML = '';
            
            // æ·»åŠ ä¸Šä¸€é¢˜æŒ‰é’®
            const prevBtn = document.createElement('button');
            prevBtn.id = 'prev-input-btn';
            prevBtn.className = 'btn btn-secondary';
            prevBtn.textContent = 'ä¸Šä¸€é¢˜';
            prevBtn.onclick = () => generateInputQuestion();
            navigationButtons.appendChild(prevBtn);
            
            // æ·»åŠ æ˜¾ç¤ºè¯¦æƒ…æŒ‰é’®
            const infoBtn = document.createElement('button');
            infoBtn.id = 'show-info-input-btn';
            infoBtn.className = 'btn';
            infoBtn.style.background = '#17a2b8';
            infoBtn.style.color = 'white';
            infoBtn.textContent = 'æ˜¾ç¤ºè¯¦æƒ…';
            infoBtn.onclick = () => toggleKanjiInfo();
            navigationButtons.appendChild(infoBtn);
            
            // æ·»åŠ ä¸‹ä¸€é¢˜æŒ‰é’®
            const nextBtn = document.createElement('button');
            nextBtn.id = 'next-input-btn';
            nextBtn.className = 'btn btn-primary';
            nextBtn.textContent = 'ä¸‹ä¸€é¢˜';
            nextBtn.onclick = () => nextQuestion();
            navigationButtons.appendChild(nextBtn);
        }

        // é‡ç½®é—®é¢˜çŠ¶æ€
        function resetQuestionState() {
            answered = false;
            document.getElementById('result-message').style.display = 'none';
            document.getElementById('kanji-info').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('next-btn').textContent = 'ä¸‹ä¸€é¢˜';
            document.getElementById('show-info-btn').style.display = 'none';
            document.getElementById('search-btn').style.display = 'inline-block';
            document.getElementById('mode-btn').style.display = 'inline-block';
            document.getElementById('kanji-display').style.fontSize = '32px';
            
            // éšè—ä¸Šä¸€ä¸ªæŒ‰é’®ï¼ˆä»…åœ¨å­¦ä¹ æ¨¡å¼æ˜¾ç¤ºï¼‰
            const prevBtn = document.getElementById('prev-btn');
            if (prevBtn) {
                prevBtn.style.display = 'none';
            }
            
            // é‡æ–°å¯ç”¨è¾“å…¥æ¡†å’Œæäº¤æŒ‰é’®
            const input = document.getElementById('reading-input');
            if (input) {
                input.disabled = false;
                const submitBtn = input.parentElement.querySelector('button');
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
            }
            
            // é‡æ–°å¯ç”¨è™šæ‹Ÿé”®ç›˜çš„æäº¤æŒ‰é’®
            const virtualSubmitBtn = document.querySelector('.submit-key');
            if (virtualSubmitBtn) {
                virtualSubmitBtn.textContent = 'æäº¤';
                virtualSubmitBtn.style.opacity = '1';
                virtualSubmitBtn.style.pointerEvents = 'auto';
                virtualSubmitBtn.setAttribute('data-key', 'submit');
            }
        }

        // ç”Ÿæˆé€‰é¡¹
        function generateOptions(correct) {
            const options = [correct];
            const allReadings = [];
            
            // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„è¯»éŸ³
            kanjiData.forEach(kanji => {
                kanji.readings.forEach(reading => {
                    if (reading.reading !== correct && !allReadings.includes(reading.reading)) {
                        allReadings.push(reading.reading);
                    }
                });
            });
            
            // éšæœºé€‰æ‹©3ä¸ªé”™è¯¯ç­”æ¡ˆ
            while (options.length < 4 && allReadings.length > 0) {
                const randomIndex = Math.floor(Math.random() * allReadings.length);
                const randomReading = allReadings[randomIndex];
                options.push(randomReading);
                allReadings.splice(randomIndex, 1);
            }
            
            // æ‰“ä¹±é€‰é¡¹é¡ºåº
            currentOptions = shuffleArray(options);
            displayOptions();
        }

        // ç”Ÿæˆä¾‹è¯æ¨¡å¼çš„é€‰é¡¹
        function generateExampleOptions(correct, readingType) {
            const options = [correct];
            const sameTypeReadings = [];
            
            // æ”¶é›†åŒç±»å‹çš„è¯»éŸ³ï¼ˆéŸ³è¯»æˆ–è®­è¯»ï¼‰
            kanjiData.forEach(kanji => {
                kanji.readings.forEach(reading => {
                    if (reading.type === readingType && 
                        reading.reading !== correct && 
                        !sameTypeReadings.includes(reading.reading)) {
                        sameTypeReadings.push(reading.reading);
                    }
                });
            });
            
            // éšæœºé€‰æ‹©3ä¸ªåŒç±»å‹çš„é”™è¯¯ç­”æ¡ˆ
            while (options.length < 4 && sameTypeReadings.length > 0) {
                const randomIndex = Math.floor(Math.random() * sameTypeReadings.length);
                const randomReading = sameTypeReadings[randomIndex];
                options.push(randomReading);
                sameTypeReadings.splice(randomIndex, 1);
            }
            
            // å¦‚æœåŒç±»å‹è¯»éŸ³ä¸å¤Ÿï¼Œä»å…¶ä»–ç±»å‹è¡¥å……
            if (options.length < 4) {
                const allReadings = [];
                kanjiData.forEach(kanji => {
                    kanji.readings.forEach(reading => {
                        if (reading.reading !== correct && 
                            !options.includes(reading.reading) &&
                            !allReadings.includes(reading.reading)) {
                            allReadings.push(reading.reading);
                        }
                    });
                });
                
                while (options.length < 4 && allReadings.length > 0) {
                    const randomIndex = Math.floor(Math.random() * allReadings.length);
                    options.push(allReadings[randomIndex]);
                    allReadings.splice(randomIndex, 1);
                }
            }
            
            // æ‰“ä¹±é€‰é¡¹é¡ºåº
            currentOptions = shuffleArray(options);
            
            // æ˜¾ç¤ºé€‰é¡¹
            displayOptions();
        }

        // æ•°ç»„æ‰“ä¹±å‡½æ•°
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // æ˜¾ç¤ºé€‰é¡¹
        function displayOptions() {
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';

            currentOptions.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectOption(option, button);
                optionsContainer.appendChild(button);
            });
        }

        // ç”Ÿæˆè¾“å…¥ç•Œé¢
        function generateInputInterface() {
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';

            // åˆ›å»ºè¾“å…¥æ¡†
            const inputDiv = document.createElement('div');
            inputDiv.style.cssText = 'margin: 20px 0; text-align: center;';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'reading-input';
            input.placeholder = 'è¯·è¾“å…¥è¯»éŸ³ï¼ˆå¹³å‡åï¼‰';
            input.style.cssText = `
                padding: 15px 20px;
                font-size: 1.2em;
                border: 2px solid #ddd;
                border-radius: 8px;
                width: 300px;
                max-width: 80%;
                text-align: center;
                margin-right: 10px;
            `;
            
            // æ£€æµ‹è®¾å¤‡ç±»å‹ - ä»…ä½¿ç”¨ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²åˆ¤æ–­
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // ç§»åŠ¨è®¾å¤‡ï¼šç¦ç”¨ç³»ç»Ÿé”®ç›˜å¹¶æ˜¾ç¤ºè™šæ‹Ÿé”®ç›˜
                input.readOnly = true;
                input.addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    showVirtualKeyboard();
                });
                
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€é¢˜ï¼Œè‡ªåŠ¨æ˜¾ç¤ºè™šæ‹Ÿé”®ç›˜
                if (!isFirstQuestion) {
                    showVirtualKeyboard();
                }
                // ç§»é™¤focusäº‹ä»¶çš„è‡ªåŠ¨å¼¹å‡ºé”®ç›˜ï¼Œåªä¿ç•™ç‚¹å‡»äº‹ä»¶
            } else {
                // ç”µè„‘è®¾å¤‡ï¼šå…è®¸ç›´æ¥é”®ç›˜è¾“å…¥
                input.readOnly = false;
                
                input.addEventListener('input', (e) => {
                    // å®æ—¶è½¬æ¢ç½—é©¬å­—ä¸ºå¹³å‡å
                    const value = e.target.value;
                    let converted = '';
                    let remaining = value;
                    
                    // ä»æœ€é•¿çš„å¯èƒ½åŒ¹é…å¼€å§‹å°è¯•è½¬æ¢
                    while (remaining.length > 0) {
                        let found = false;
                        
                        // ç‰¹æ®Šå¤„ç†nï¼šåªæœ‰åœ¨ç‰¹å®šæƒ…å†µä¸‹æ‰è½¬æ¢ä¸ºã‚“
                        if (remaining.startsWith('n')) {
                            // å¦‚æœæ˜¯nnï¼Œè½¬æ¢ä¸ºã‚“
                            if (remaining.startsWith('nn')) {
                                converted += 'ã‚“';
                                remaining = remaining.substring(2);
                                found = true;
                            }
                            // å¦‚æœnåé¢è·Ÿç€è¾…éŸ³ï¼ˆé™¤äº†yï¼‰ï¼Œè½¬æ¢ä¸ºã‚“
                            else if (remaining.length > 1) {
                                const nextChar = remaining.charAt(1);
                                if (nextChar && 'bcdfghjklmpqrstvwxz'.includes(nextChar) && nextChar !== 'y') {
                                    converted += 'ã‚“';
                                    remaining = remaining.substring(1);
                                    found = true;
                                }
                            }
                        }
                        
                        // å¦‚æœnæ²¡æœ‰è¢«ç‰¹æ®Šå¤„ç†ï¼Œå°è¯•æ­£å¸¸çš„ç½—é©¬å­—åŒ¹é…
                        if (!found) {
                            // å°è¯•ä»æœ€é•¿åˆ°æœ€çŸ­çš„åŒ¹é…
                            for (let len = Math.min(remaining.length, 3); len > 0; len--) {
                                const substr = remaining.substring(0, len);
                                const hiragana = romajiToHiragana[substr];
                                
                                if (hiragana) {
                                    converted += hiragana;
                                    remaining = remaining.substring(len);
                                    found = true;
                                    break;
                                }
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯éƒ¨åˆ†è¾“å…¥
                        if (!found) {
                            // æ£€æŸ¥å½“å‰è¾“å…¥æ˜¯å¦æ˜¯æŸä¸ªç½—é©¬å­—çš„å¼€å¤´
                            let isPartial = false;
                            for (const romaji in romajiToHiragana) {
                                if (romaji.startsWith(remaining)) {
                                    isPartial = true;
                                    break;
                                }
                            }
                            
                            if (isPartial) {
                                // æ˜¯éƒ¨åˆ†è¾“å…¥ï¼Œä¿ç•™ä¸è½¬æ¢
                                break;
                            } else {
                                // ä¸æ˜¯æœ‰æ•ˆè¾“å…¥ï¼Œè·³è¿‡ç¬¬ä¸€ä¸ªå­—ç¬¦
                                remaining = remaining.substring(1);
                            }
                        }
                    }
                    
                    // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤ºè½¬æ¢åçš„å†…å®¹
                    const finalValue = converted + remaining;
                    if (finalValue !== value) {
                        e.target.value = finalValue;
                        // å°†å…‰æ ‡ç§»åŠ¨åˆ°å†…å®¹æœ«å°¾ï¼Œå…è®¸ç»§ç»­è¾“å…¥
                        const newCursorPos = finalValue.length;
                        e.target.setSelectionRange(newCursorPos, newCursorPos);
                    }
                });
                
                // æ·»åŠ å›è½¦é”®æäº¤åŠŸèƒ½
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        checkInputAnswer();
                    }
                });
            }
            
            // åˆ›å»ºæäº¤æŒ‰é’®
            const submitBtn = document.createElement('button');
            submitBtn.textContent = 'æäº¤';
            submitBtn.className = 'btn btn-primary';
            submitBtn.style.cssText = `
                padding: 15px 25px;
                font-size: 1.1em;
                margin-left: 10px;
            `;
            submitBtn.onclick = () => checkInputAnswer();
            
            inputDiv.appendChild(input);
            inputDiv.appendChild(submitBtn);
            optionsContainer.appendChild(inputDiv);
            
            // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
            setTimeout(() => input.focus(), 100);
            
            // åªåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šåˆ›å»ºè™šæ‹Ÿé”®ç›˜
            if (isMobile) {
                createVirtualKeyboard();
            }
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(selectedAnswer, buttonElement) {
            if (answered) return;

            answered = true;
            gameStats.total++;

            // ç¦ç”¨æ‰€æœ‰é€‰é¡¹æŒ‰é’®
            const allButtons = document.querySelectorAll('.option-btn');
            allButtons.forEach(btn => btn.disabled = true);

            // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆå’Œç”¨æˆ·é€‰æ‹©
            allButtons.forEach(btn => {
                if (btn.textContent === correctAnswer) {
                    btn.classList.add('correct');
                } else if (btn === buttonElement && btn.textContent !== correctAnswer) {
                    btn.classList.add('incorrect');
                }
            });

            // æ˜¾ç¤ºç»“æœæ¶ˆæ¯
            const resultMessage = document.getElementById('result-message');
            if (selectedAnswer === correctAnswer) {
                gameStats.correct++;
                resultMessage.textContent = 'æ­£ç¡®ï¼';
                resultMessage.className = 'result-message result-correct';
                
                // æœ‰é™æ¨¡å¼ï¼šç­”å¯¹æ—¶ç§»åŠ¨åˆ°å·²å®Œæˆåˆ—è¡¨
                if (isFiniteMode && currentExample) {
                    handleFiniteCorrectAnswer();
                }
                
                // å¦‚æœæ˜¯å¤ä¹ æ¨¡å¼ä¸”ç­”å¯¹äº†ï¼Œå®Œæˆå¤ä¹ ä»»åŠ¡
                if (gameMode === 'example' && currentExample) {
                    completeReview(currentExample.kanji);
                }
                
                // ç­”å¯¹å0.3ç§’è‡ªåŠ¨è·³è½¬ä¸‹ä¸€é¢˜
                setTimeout(() => {
                    nextQuestion();
                }, 300);
            } else {
                resultMessage.textContent = `é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${correctAnswer}`;
                resultMessage.className = 'result-message result-incorrect';
                
                // æœ‰é™æ¨¡å¼ï¼šç­”é”™æ—¶ä¿æŒåœ¨å‰©ä½™åˆ—è¡¨ä¸­ï¼ˆä¸åšå¤„ç†ï¼Œç»§ç»­å‚ä¸éšæœºå‡ºé¢˜ï¼‰
                
                // ç­”é”™æ—¶æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
                document.getElementById('next-btn').style.display = 'inline-block';
                document.getElementById('show-info-btn').style.display = 'inline-block';
            }
            resultMessage.style.display = 'block';

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
        }

        // å¤„ç†æœ‰é™æ¨¡å¼ç­”å¯¹çš„æƒ…å†µ
        function handleFiniteCorrectAnswer() {
            if (!currentExample) return;
            
            // ä»å‰©ä½™ä¾‹è¯ä¸­ç§»é™¤å½“å‰ä¾‹è¯
            const currentIndex = remainingKanji.findIndex(item => 
                item.kanji === currentExample.kanji && 
                item.example === currentExample.example && 
                item.reading === currentExample.reading
            );
            
            if (currentIndex !== -1) {
                const completedItem = remainingKanji.splice(currentIndex, 1)[0];
                completedKanji.push(completedItem);
                console.log(`ç­”å¯¹äº†ï¼å‰©ä½™ ${remainingKanji.length} é¢˜ï¼Œå·²å®Œæˆ ${completedKanji.length} é¢˜`);
            }
        }

        // æ£€æŸ¥è¾“å…¥ç­”æ¡ˆ
        function checkInputAnswer() {
            if (answered) return;
            
            const input = document.getElementById('reading-input');
            const userInput = input.value.trim();
            
            if (!userInput) {
                alert('è¯·è¾“å…¥è¯»éŸ³');
                return;
            }
            
            answered = true;
            gameStats.total++;
            
            // ç¦ç”¨è¾“å…¥æ¡†å’Œæäº¤æŒ‰é’®
            input.disabled = true;
            const submitBtn = input.parentElement.querySelector('button');
            if (submitBtn) {
                submitBtn.disabled = true;
            }
            
            // ç¦ç”¨è™šæ‹Ÿé”®ç›˜çš„æäº¤æŒ‰é’®
            const virtualSubmitBtn = document.querySelector('.submit-key');
            if (virtualSubmitBtn) {
                virtualSubmitBtn.style.opacity = '0.5';
                virtualSubmitBtn.style.pointerEvents = 'none';
            }
            
            // éªŒè¯ç­”æ¡ˆï¼ˆæ”¯æŒè¯­å¹²éƒ¨åˆ†å’Œå®Œæ•´è¯»éŸ³ï¼‰
            let isCorrect = false;
            
            // æ£€æŸ¥æ˜¯å¦åŒ¹é…å®Œæ•´è¯»éŸ³
            if (userInput === correctAnswer) {
                isCorrect = true;
            } else {
                // æ£€æŸ¥æ˜¯å¦åŒ¹é…è¯­å¹²éƒ¨åˆ†ï¼ˆå»æ‰é€å‡åï¼‰
                // æ‰¾åˆ°æ±‰å­—åœ¨ä¾‹è¯ä¸­çš„ä½ç½®ï¼Œæå–å¯¹åº”çš„è¯»éŸ³éƒ¨åˆ†
                if (currentExample && currentExample.kanji && currentExample.word && currentExample.reading) {
                    const kanjiIndex = currentExample.word.indexOf(currentExample.kanji);
                    if (kanjiIndex !== -1) {
                        // è®¡ç®—æ±‰å­—å¯¹åº”çš„è¯»éŸ³é•¿åº¦ï¼ˆç®€å•ä¼°ç®—ï¼‰
                        const wordLength = currentExample.word.length;
                        const readingLength = currentExample.reading.length;
                        const kanjiLength = currentExample.kanji.length;
                        
                        // æå–æ±‰å­—éƒ¨åˆ†çš„è¯»éŸ³ï¼ˆå»æ‰å¯èƒ½çš„é€å‡åï¼‰
                        let kanjiReading = '';
                        if (kanjiIndex === 0) {
                            // æ±‰å­—åœ¨å¼€å¤´ï¼Œå–å‰é¢éƒ¨åˆ†
                            const estimatedLength = Math.floor(readingLength * kanjiLength / wordLength);
                            kanjiReading = currentExample.reading.substring(0, Math.max(1, estimatedLength));
                        } else {
                            // æ±‰å­—åœ¨ä¸­é—´æˆ–æœ«å°¾ï¼Œéœ€è¦æ›´å¤æ‚çš„å¤„ç†
                            // ç®€åŒ–å¤„ç†ï¼šå¦‚æœç”¨æˆ·è¾“å…¥æ˜¯æ­£ç¡®ç­”æ¡ˆçš„å­ä¸²ï¼Œä¹Ÿè®¤ä¸ºæ­£ç¡®
                            if (correctAnswer.includes(userInput) && userInput.length >= 1) {
                                isCorrect = true;
                            }
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ¹é…æå–çš„æ±‰å­—è¯»éŸ³
                        if (kanjiReading && userInput === kanjiReading) {
                            isCorrect = true;
                        }
                    }
                }
                
                // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœç”¨æˆ·è¾“å…¥æ˜¯æ­£ç¡®ç­”æ¡ˆçš„å¼€å¤´éƒ¨åˆ†ï¼ˆè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰ï¼Œä¹Ÿè®¤ä¸ºæ­£ç¡®
                if (!isCorrect && userInput.length >= 2 && correctAnswer.startsWith(userInput)) {
                    isCorrect = true;
                }
            }
            
            // æ˜¾ç¤ºç»“æœ
            const resultMessage = document.getElementById('result-message');
            if (isCorrect) {
                gameStats.correct++;
                resultMessage.textContent = 'æ­£ç¡®ï¼';
                resultMessage.className = 'result-message result-correct';
                
                // æœ‰é™æ¨¡å¼ä¸‹ç­”å¯¹æ—¶çš„å¤„ç†
                if (isFiniteMode && currentExample) {
                    handleFiniteCorrectAnswer();
                }
                
                // å¦‚æœæ˜¯å¤ä¹ æ¨¡å¼ä¸”ç­”å¯¹äº†ï¼Œå®Œæˆå¤ä¹ ä»»åŠ¡
                if (gameMode === 'input' && currentExample) {
                    completeReview(currentExample.kanji);
                }
                
                // ç­”å¯¹å0.3ç§’è‡ªåŠ¨è·³è½¬ä¸‹ä¸€é¢˜
                setTimeout(() => {
                    nextQuestion();
                }, 300);
            } else {
                resultMessage.textContent = `é”™è¯¯ï¼æ­£ç¡®è¯»éŸ³æ˜¯ï¼š${correctAnswer}`;
                resultMessage.className = 'result-message result-incorrect';
                
                // æœ‰é™æ¨¡å¼ä¸‹ç­”é”™æ—¶çš„å¤„ç†ï¼ˆå¯ä»¥é€‰æ‹©æ˜¯å¦ä»é¢˜åº“ä¸­ç§»é™¤ï¼‰
                // è¿™é‡Œé€‰æ‹©ä¸ç§»é™¤ï¼Œè®©ç”¨æˆ·æœ‰æœºä¼šé‡æ–°ç­”é¢˜
                
                // ç­”é”™æ—¶æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
                document.getElementById('next-btn').style.display = 'inline-block';
                document.getElementById('show-info-btn').style.display = 'inline-block';
                
                // å°†è™šæ‹Ÿé”®ç›˜çš„æäº¤æŒ‰é’®æ”¹ä¸ºä¸‹ä¸€é¢˜æŒ‰é’®
                const virtualSubmitBtn = document.querySelector('.submit-key');
                if (virtualSubmitBtn) {
                    virtualSubmitBtn.textContent = 'ä¸‹ä¸€é¢˜';
                    virtualSubmitBtn.style.opacity = '1';
                    virtualSubmitBtn.style.pointerEvents = 'auto';
                    virtualSubmitBtn.setAttribute('data-key', 'next');
                }
            }
            resultMessage.style.display = 'block';
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            // ç»Ÿè®¡åŒºåŸŸå·²ç§»é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ä¸ºç©ºä»¥é¿å…é”™è¯¯
        }

        // æ˜¾ç¤º/éšè—æ±‰å­—è¯¦æƒ…
        function toggleKanjiInfo() {
            const infoDiv = document.getElementById('kanji-info');
            if (infoDiv.style.display === 'none') {
                showKanjiInfo();
                document.getElementById('show-info-btn').textContent = 'éšè—è¯¦æƒ…';
            } else {
                infoDiv.style.display = 'none';
                document.getElementById('show-info-btn').textContent = 'æ˜¾ç¤ºè¯¦æƒ…';
            }
        }

        // æ˜¾ç¤ºæ±‰å­—è¯¦æƒ…
        function showKanjiInfo() {
            const infoDiv = document.getElementById('kanji-info');
            let html = ``;
            
            if (currentKanji.variant) {
                html += `<p><strong>å¼‚ä½“å­—ï¼š</strong>${currentKanji.variant}</p>`;
            }

            html += '<div>';
            
            // åˆ†åˆ«å¤„ç†éŸ³è¯»å’Œè®­è¯»
            const onReadings = currentKanji.readings.filter(r => r.type === 'on');
            const kunReadings = currentKanji.readings.filter(r => r.type === 'kun');
            
            // æ˜¾ç¤ºéŸ³è¯»
            onReadings.forEach(reading => {
                html += `
                    <div style="margin: 5px 0; padding: 5px; border-left: 3px solid #667eea;">
                        <span class="reading-type">éŸ³è¯»</span>
                        <strong>${reading.reading}</strong>
                        ${reading.okurigana_pattern ? `(${reading.okurigana_pattern})` : ''}
                        <div class="examples">ä¾‹è¯ï¼š${reading.examples.join('ã€')}</div>
                    </div>
                `;
            });
            
            // åˆå¹¶å¤„ç†è®­è¯»
            const mergedKunReadings = mergeKunReadings(kunReadings);
            mergedKunReadings.forEach(reading => {
                html += `
                    <div style="margin: 5px 0; padding: 5px; border-left: 3px solid #667eea;">
                        <span class="reading-type">è®­è¯»</span>
                        <strong>${reading.reading}</strong>
                        <div class="examples">ä¾‹è¯ï¼š${reading.examples.join('ã€')}</div>
                    </div>
                `;
            });
            
            html += '</div>';

            if (currentKanji.notes) {
                html += `<p><strong>æ³¨é‡Šï¼š</strong>${currentKanji.notes}</p>`;
            }
            
            // æ£€æŸ¥å¹¶æ˜¾ç¤ºå¼‚ä½“å­—å¤‡æ³¨
            if (currentKanji.variant) {
                html += `
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                        <p style="margin: 0; color: #856404; font-size: 0.9em;">
                            <strong>ğŸ’¡ å¼‚ä½“å­—æé†’ï¼š</strong>æ­¤æ±‰å­—æœ‰å¼‚ä½“å­— <strong>${currentKanji.variant}</strong>ï¼Œåœ¨ä¸åŒçš„æ–‡çŒ®æˆ–åœ°åŒºå¯èƒ½ä¼šçœ‹åˆ°è¿™ç§å†™æ³•ã€‚
                        </p>
                    </div>
                `;
            }

            infoDiv.innerHTML = html;
            infoDiv.style.display = 'block';
        }
        
        // åˆå¹¶ç›¸åŒè¯­å¹²çš„è®­è¯»
        function mergeKunReadings(kunReadings) {
            const merged = [];
            const processed = new Set();
            
            kunReadings.forEach(reading => {
                if (processed.has(reading.reading)) return;
                
                // æŸ¥æ‰¾ç›¸åŒè¯­å¹²çš„è¯»éŸ³
                const stem = extractStem(reading);
                const sameStems = kunReadings.filter(r => 
                    !processed.has(r.reading) && extractStem(r) === stem
                );
                
                if (sameStems.length > 1) {
                    // åˆå¹¶æ˜¾ç¤ºï¼Œåªæ˜¾ç¤ºè¯­å¹²éƒ¨åˆ†
            const allExamples = [];
            sameStems.forEach(r => {
                if (r.examples) allExamples.push(...r.examples);
                processed.add(r.reading);
            });
            
            merged.push({
                reading: stem,
                examples: [...new Set(allExamples)] // å»é‡
            });
                } else {
                    // å•ç‹¬æ˜¾ç¤ºï¼Œä¹Ÿåªæ˜¾ç¤ºè¯­å¹²éƒ¨åˆ†
                    merged.push({
                        reading: stem,
                        examples: reading.examples || []
                    });
                    processed.add(reading.reading);
                }
            });
            
            return merged;
        }
        
        // æå–è¯­å¹²ï¼ˆä½¿ç”¨okurigana_patternä¸­çš„ï½¥åˆ†éš”ç¬¦ï¼‰
        function extractStem(readingObj) {
            // å¦‚æœæœ‰okurigana_patternä¸”åŒ…å«ï½¥åˆ†éš”ç¬¦ï¼Œç›´æ¥æå–è¯­å¹²
            if (readingObj.okurigana_pattern && readingObj.okurigana_pattern.includes('ï½¥')) {
                return readingObj.okurigana_pattern.split('ï½¥')[0];
            }
            // å¦‚æœæ²¡æœ‰okurigana_patternï¼Œè¿”å›å®Œæ•´è¯»éŸ³ä½œä¸ºè¯­å¹²
            return readingObj.reading;
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            gameStats.correct = 0;
            gameStats.total = 0;
            updateStats();
            nextQuestion();
        }

        // æ˜¾ç¤ºè®¡åˆ’æ¨¡å¼
        function showPlanMode() {
            document.getElementById('result-message').style.display = 'none';
            document.getElementById('kanji-info').style.display = 'none';
            document.getElementById('options').innerHTML = '';
            document.getElementById('question').textContent = 'å­¦ä¹ è®¡åˆ’è®¾ç½®';
            document.getElementById('kanji-display').style.fontSize = '32px';
            document.getElementById('kanji-display').innerHTML = `
                <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                    <h3 style="margin-bottom: 2px; color: #333; font-size: 0.75em;">ğŸ“š å­¦ä¹ è®¡åˆ’ç®¡ç†</h3>
                    
                    <div style="background: #f8f9fa; padding: 3px; border-radius: 3px; margin-bottom: 3px;">
                        <h4 style="color: #667eea; margin-bottom: 2px; font-size: 0.6em;">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2px;">
                            <div style="text-align: center; padding: 2px; background: white; border-radius: 2px;">
                                <div style="font-size: 0.8em; font-weight: bold; color: #28a745;">${studyPlan.learnedWords.length}</div>
                                <div style="color: #666; font-size: 0.5em;">å·²å­¦æ±‰å­—</div>
                            </div>
                            <div style="text-align: center; padding: 2px; background: white; border-radius: 2px;">
                                <div style="font-size: 0.8em; font-weight: bold; color: #dc3545;">${getTodayReviewCount()}</div>
                                <div style="color: #666; font-size: 0.5em;">ä»Šæ—¥å¤ä¹ </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 3px; border-radius: 3px; margin-bottom: 10px;">
                        <h4 style="color: #667eea; margin-bottom: 2px; font-size: 0.6em;">ğŸ”„ è‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’</h4>
                        <div style="font-size: 0.5em; color: #666; margin-bottom: 2px;">
                            å¤ä¹ é—´éš”ï¼š1å¤© â†’ 3å¤© â†’ 7å¤© â†’ 15å¤© â†’ 30å¤©
                        </div>
                        <div id="review-schedule" style="max-height: 60px; overflow-y: auto;">
                            ${getReviewScheduleHTML()}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="toggleMode()" class="btn" style="padding: 8px 16px; font-size: 1em; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            åˆ‡æ¢æ¨¡å¼
                        </button>
                    </div>
                </div>
            `;
            
            // éšè—ä¸éœ€è¦çš„æŒ‰é’®
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('show-info-btn').style.display = 'none';
            document.getElementById('search-btn').style.display = 'none';
            document.getElementById('mode-btn').style.display = 'none';
            const prevBtn = document.getElementById('prev-btn');
            if (prevBtn) prevBtn.style.display = 'none';
            
            // æ¸…ç©ºåŠ¨æ€ç”Ÿæˆçš„å¯¼èˆªæŒ‰é’®
            const navigationButtons = document.querySelector('.navigation-buttons');
            if (navigationButtons) {
                navigationButtons.innerHTML = '';
            }
        }



        // è·å–ä»Šæ—¥å¤ä¹ æ•°é‡
        function getTodayReviewCount() {
            const today = new Date().toDateString();
            return studyPlan.reviewSchedule.filter(item => 
                new Date(item.reviewDate).toDateString() === today
            ).length;
        }

        // è·å–å¤ä¹ è®¡åˆ’HTML
        function getReviewScheduleHTML() {
            if (studyPlan.reviewSchedule.length === 0) {
                return '<div style="color: #999; text-align: center; padding: 2px; font-size: 0.5em;">æš‚æ— å¤ä¹ è®¡åˆ’</div>';
            }
            
            const today = new Date();
            const upcoming = studyPlan.reviewSchedule
                .filter(item => new Date(item.reviewDate) >= today)
                .sort((a, b) => new Date(a.reviewDate) - new Date(b.reviewDate))
                .slice(0, 10);
            
            return upcoming.map(item => {
                const date = new Date(item.reviewDate);
                const isToday = date.toDateString() === today.toDateString();
                const dateStr = date.toLocaleDateString('zh-CN');
                const kanjiInfo = kanjiData.find(k => k.kanji === item.kanji);
                
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; 
                                padding: 1px 2px; margin: 0.5px 0; background: ${isToday ? '#fff3cd' : 'white'}; 
                                border-radius: 1px; border-left: 1px solid ${isToday ? '#ffc107' : '#667eea'};">
                        <span style="font-weight: bold; font-size: 0.7em;">${item.kanji}</span>
                        <span style="color: #666; font-size: 0.5em;">${dateStr} ${isToday ? '(ä»Šå¤©)' : ''}</span>
                    </div>
                `;
            }).join('');
        }

        // è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿é—´éš”ï¼ˆå¤©æ•°ï¼‰
        const EBBINGHAUS_INTERVALS = [1, 3, 7, 15, 30];

        // æ·»åŠ æ±‰å­—åˆ°å­¦ä¹ è®¡åˆ’
        function addToLearned(kanji) {
            if (!studyPlan.learnedWords.find(item => item.kanji === kanji)) {
                const learnedItem = {
                    kanji: kanji,
                    learnDate: new Date().toISOString(),
                    reviewCount: 0,
                    nextReviewDate: getNextReviewDate(0)
                };
                
                studyPlan.learnedWords.push(learnedItem);
                scheduleReview(learnedItem);
                savePlan();
            }
        }

        // è·å–ä¸‹æ¬¡å¤ä¹ æ—¥æœŸ
        function getNextReviewDate(reviewCount) {
            const intervalIndex = Math.min(reviewCount, EBBINGHAUS_INTERVALS.length - 1);
            const interval = EBBINGHAUS_INTERVALS[intervalIndex];
            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + interval);
            return nextDate.toISOString();
        }

        // å®‰æ’å¤ä¹ 
        function scheduleReview(learnedItem) {
            const reviewItem = {
                kanji: learnedItem.kanji,
                reviewDate: learnedItem.nextReviewDate,
                reviewCount: learnedItem.reviewCount
            };
            
            // ç§»é™¤æ—§çš„å¤ä¹ è®¡åˆ’
            studyPlan.reviewSchedule = studyPlan.reviewSchedule.filter(
                item => item.kanji !== learnedItem.kanji || item.reviewCount !== learnedItem.reviewCount
            );
            
            // æ·»åŠ æ–°çš„å¤ä¹ è®¡åˆ’
            studyPlan.reviewSchedule.push(reviewItem);
        }

        // å®Œæˆå¤ä¹ 
        function completeReview(kanji) {
            const learnedItem = studyPlan.learnedWords.find(item => item.kanji === kanji);
            if (learnedItem) {
                learnedItem.reviewCount++;
                learnedItem.nextReviewDate = getNextReviewDate(learnedItem.reviewCount);
                
                // å¦‚æœè¿˜éœ€è¦ç»§ç»­å¤ä¹ ï¼Œå®‰æ’ä¸‹æ¬¡å¤ä¹ 
                if (learnedItem.reviewCount < EBBINGHAUS_INTERVALS.length) {
                    scheduleReview(learnedItem);
                }
                
                // ç§»é™¤ä»Šå¤©çš„å¤ä¹ ä»»åŠ¡
                const today = new Date().toDateString();
                studyPlan.reviewSchedule = studyPlan.reviewSchedule.filter(
                    item => !(item.kanji === kanji && new Date(item.reviewDate).toDateString() === today)
                );
                
                savePlan();
            }
        }

        // ä¿å­˜å­¦ä¹ è®¡åˆ’
        function savePlan() {
            localStorage.setItem('kanjiStudyPlan', JSON.stringify(studyPlan));
        }

        // åŠ è½½å­¦ä¹ è®¡åˆ’
        function loadPlan() {
            const saved = localStorage.getItem('kanjiStudyPlan');
            if (saved) {
                studyPlan = { ...studyPlan, ...JSON.parse(saved) };
            }
        }

        // ä¿®æ”¹å­¦ä¹ æ¨¡å¼ï¼Œæ·»åŠ å­¦ä¹ è¿›åº¦è·Ÿè¸ª
        function enhancedShowStudyMode() {
            // è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ä¸€ä¸ªæœªå­¦çš„æ±‰å­—
            findFirstUnlearnedKanji();
            
            showStudyMode();
            
            // ä¸ºå·²å­¦æ±‰å­—æ·»åŠ çŠ¶æ€æ˜¾ç¤º
            const kanjiInfo = document.getElementById('kanji-info');
            if (kanjiInfo && kanjiInfo.style.display !== 'none') {
                const currentKanjiChar = document.getElementById('kanji-display').textContent;
                const isLearned = studyPlan.learnedWords.find(item => item.kanji === currentKanjiChar);
                
                if (isLearned) {
                    const statusDiv = document.createElement('div');
                    statusDiv.innerHTML = '<span style="color: #28a745; font-weight: bold;">âœ“ å·²å­¦ä¹ </span>';
                    statusDiv.style.marginTop = '10px';
                    kanjiInfo.appendChild(statusDiv);
                }
                // ç§»é™¤è¿™é‡Œçš„æ ‡è®°ä¸ºå·²å­¦æŒ‰é’®ï¼Œå› ä¸ºå·²ç»ç§»åˆ°controlsåŒºåŸŸäº†
            }
        }
        
        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœªå­¦çš„æ±‰å­—
        function findFirstUnlearnedKanji() {
            if (kanjiData.length === 0) return;
            
            const learnedKanji = studyPlan.learnedWords.map(item => item.kanji);
            
            // æ€»æ˜¯ä»å¤´å¼€å§‹æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœªå­¦çš„æ±‰å­—
            for (let i = 0; i < kanjiData.length; i++) {
                const kanji = kanjiData[i].kanji;
                
                if (!learnedKanji.includes(kanji)) {
                    studyIndex = i;
                    studyPlan.studyIndex = i;
                    savePlan();
                    return;
                }
            }
            
            // å¦‚æœæ‰€æœ‰æ±‰å­—éƒ½å·²å­¦ä¹ ï¼Œä»å¤´å¼€å§‹
            studyIndex = 0;
            studyPlan.studyIndex = 0;
            savePlan();
        }

        // å·¥å…·å‡½æ•°ï¼šæ‰“ä¹±æ•°ç»„
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // æœç´¢æ±‰å­—åŠŸèƒ½
        function searchKanji() {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
                return;
            }
            
            const results = [];
            const searchLower = searchTerm.toLowerCase();
            
            kanjiData.forEach((kanjiEntry, index) => {
                let matchScore = 0;
                let matchType = '';
                
                // æœç´¢æ±‰å­—æœ¬èº«
                if (kanjiEntry.kanji.includes(searchTerm)) {
                    matchScore = 100;
                    matchType = 'æ±‰å­—åŒ¹é…';
                }
                // æœç´¢è¯»éŸ³
                else if (kanjiEntry.readings.some(reading => 
                    reading.reading.toLowerCase().includes(searchLower))) {
                    matchScore = 80;
                    matchType = 'è¯»éŸ³åŒ¹é…';
                }
                // æœç´¢ä¾‹è¯
                else if (kanjiEntry.readings.some(reading => 
                    reading.examples && reading.examples.some(example => 
                        example.toLowerCase().includes(searchLower)))) {
                    matchScore = 60;
                    matchType = 'ä¾‹è¯åŒ¹é…';
                }
                // æœç´¢å«ä¹‰ï¼ˆå¦‚æœæœ‰noteså­—æ®µï¼‰
                else if (kanjiEntry.notes && kanjiEntry.notes.toLowerCase().includes(searchLower)) {
                    matchScore = 40;
                    matchType = 'å«ä¹‰åŒ¹é…';
                }
                
                if (matchScore > 0) {
                    results.push({
                        kanji: kanjiEntry.kanji,
                        index: index,
                        score: matchScore,
                        type: matchType,
                        entry: kanjiEntry
                    });
                }
            });
            
            // æŒ‰åŒ¹é…åˆ†æ•°æ’åº
            results.sort((a, b) => b.score - a.score);
            
            displaySearchResults(results, searchTerm);
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results, searchTerm) {
            const resultsContainer = document.getElementById('search-results');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        æœªæ‰¾åˆ°åŒ…å«"${searchTerm}"çš„æ±‰å­—
                    </div>
                `;
                resultsContainer.style.display = 'block';
                return;
            }
            
            const maxResults = 10; // æœ€å¤šæ˜¾ç¤º10ä¸ªç»“æœ
            const displayResults = results.slice(0, maxResults);
            
            let html = `
                <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                    <strong>æœç´¢ç»“æœï¼š</strong>æ‰¾åˆ° ${results.length} ä¸ªåŒ¹é…é¡¹${results.length > maxResults ? `ï¼ˆæ˜¾ç¤ºå‰${maxResults}ä¸ªï¼‰` : ''}
                </div>
            `;
            
            displayResults.forEach(result => {
                const readings = result.entry.readings.map(r => r.reading).join('ã€');
                const examples = result.entry.readings
                    .flatMap(r => r.examples || [])
                    .slice(0, 3)
                    .join('ã€');
                
                html += `
                    <div class="search-result-item" 
                         style="padding: 12px; margin: 8px 0; background: white; border-radius: 8px; 
                                border-left: 4px solid #667eea; cursor: pointer; transition: all 0.3s;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.1);" 
                         onclick="jumpToKanji(${result.index})" 
                         onmouseover="this.style.backgroundColor='#f0f4ff'; this.style.transform='translateX(5px)'" 
                         onmouseout="this.style.backgroundColor='white'; this.style.transform='translateX(0)'">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 2em; font-weight: bold; color: #333;">${result.kanji}</span>
                                <div>
                                    <div style="color: #667eea; font-weight: bold; margin-bottom: 4px;">${readings}</div>
                                    ${examples ? `<div style="color: #666; font-size: 0.9em;">ä¾‹è¯ï¼š${examples}</div>` : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #667eea; color: white; padding: 4px 8px; 
                                           border-radius: 12px; font-size: 0.8em;">${result.type}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        }
        
        // è·³è½¬åˆ°æŒ‡å®šæ±‰å­—
        function jumpToKanji(index) {
            studyIndex = index;
            studyPlan.studyIndex = index;
            savePlan();
            
            // åˆ‡æ¢åˆ°å­¦ä¹ æ¨¡å¼
            if (gameMode !== 'study') {
                gameMode = 'study';
                updateModeInfo();
            }
            
            // ç›´æ¥æ˜¾ç¤ºæŒ‡å®šæ±‰å­—ï¼Œä¸è‡ªåŠ¨è·³è½¬åˆ°æœªå­¦æ±‰å­—
            showStudyMode();
            
            // ä¸ºå·²å­¦æ±‰å­—æ·»åŠ çŠ¶æ€æ˜¾ç¤º
            const kanjiInfo = document.getElementById('kanji-info');
            if (kanjiInfo && kanjiInfo.style.display !== 'none') {
                const currentKanjiChar = document.getElementById('kanji-display').textContent;
                const isLearned = studyPlan.learnedWords.find(item => item.kanji === currentKanjiChar);
                
                if (isLearned) {
                    const statusDiv = document.createElement('div');
                    statusDiv.innerHTML = '<span style="color: #28a745; font-weight: bold;">âœ“ å·²å­¦ä¹ </span>';
                    statusDiv.style.marginTop = '10px';
                    kanjiInfo.appendChild(statusDiv);
                }
                // ç§»é™¤è¿™é‡Œçš„æ ‡è®°ä¸ºå·²å­¦æŒ‰é’®ï¼Œå› ä¸ºå·²ç»ç§»åˆ°controlsåŒºåŸŸäº†
            }
            
            clearSearch();
            
            // æ»šåŠ¨åˆ°æ¸¸æˆåŒºåŸŸ
            document.querySelector('.game-area').scrollIntoView({ behavior: 'smooth' });
        }
        
        // åˆ‡æ¢æœç´¢æ¡†æ˜¾ç¤º
        function toggleSearch() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            
            if (searchContainer.style.display === 'none') {
                // å±•å¼€æœç´¢æ¡†
                searchContainer.style.display = 'block';
                searchContainer.style.opacity = '0';
                searchContainer.style.transform = 'scaleX(0)';
                searchContainer.style.transition = 'all 0.3s ease';
                
                // è§¦å‘åŠ¨ç”»
                setTimeout(() => {
                    searchContainer.style.opacity = '1';
                    searchContainer.style.transform = 'scaleX(1)';
                }, 10);
                
                // èšç„¦è¾“å…¥æ¡†
                setTimeout(() => {
                    searchInput.focus();
                }, 300);
            } else {
                // æ”¶èµ·æœç´¢æ¡†
                searchContainer.style.opacity = '0';
                searchContainer.style.transform = 'scaleX(0)';
                
                setTimeout(() => {
                    searchContainer.style.display = 'none';
                    // æ¸…é™¤æœç´¢ç»“æœ
                    document.getElementById('search-results').style.display = 'none';
                    searchInput.value = '';
                }, 300);
            }
        }
        
        // æ¸…é™¤æœç´¢
        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').style.display = 'none';
        }
        
        // å¤„ç†æœç´¢æ¡†å›è½¦é”®
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchKanji();
            }
        }
        
        // ç§»åŠ¨ç«¯ä¼˜åŒ–å‡½æ•°
        function initMobileOptimizations() {
            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // é˜²æ­¢é•¿æŒ‰é€‰æ‹©æ–‡æœ¬
            document.addEventListener('selectstart', function(e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            });
            
            // ä¼˜åŒ–è§¦æ‘¸åé¦ˆ
            const touchElements = document.querySelectorAll('.option-btn, .btn');
            touchElements.forEach(element => {
                element.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                    this.style.transition = 'transform 0.1s';
                });
                
                element.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 100);
                });
                
                element.addEventListener('touchcancel', function() {
                    this.style.transform = '';
                });
            });
            
            // æ£€æµ‹è®¾å¤‡æ–¹å‘å˜åŒ–
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    window.scrollTo(0, 0);
                }, 100);
            });
            
            // ä¼˜åŒ–iOS Safariçš„æ»šåŠ¨
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                document.body.style.webkitOverflowScrolling = 'touch';
            }
        }
        
        // è™šæ‹Ÿé”®ç›˜ç›¸å…³å˜é‡
        let virtualKeyboard = null;
        let isKeyboardVisible = false;
        let currentRomajiInput = '';
        let convertedText = '';
        
        // ç½—é©¬å­—åˆ°å¹³å‡åè½¬æ¢è¡¨
        const romajiToHiragana = {
            // å•ä¸ªå‡å
            'a': 'ã‚', 'i': 'ã„', 'u': 'ã†', 'e': 'ãˆ', 'o': 'ãŠ',
            'ka': 'ã‹', 'ki': 'ã', 'ku': 'ã', 'ke': 'ã‘', 'ko': 'ã“',
            'ga': 'ãŒ', 'gi': 'ã', 'gu': 'ã', 'ge': 'ã’', 'go': 'ã”',
            'sa': 'ã•', 'si': 'ã—', 'shi': 'ã—', 'su': 'ã™', 'se': 'ã›', 'so': 'ã',
            'za': 'ã–', 'zi': 'ã˜', 'ji': 'ã˜', 'zu': 'ãš', 'ze': 'ãœ', 'zo': 'ã',
            'ta': 'ãŸ', 'ti': 'ã¡', 'chi': 'ã¡', 'tu': 'ã¤', 'tsu': 'ã¤', 'te': 'ã¦', 'to': 'ã¨',
            'da': 'ã ', 'di': 'ã¢', 'du': 'ã¥', 'de': 'ã§', 'do': 'ã©',
            'na': 'ãª', 'ni': 'ã«', 'nu': 'ã¬', 'ne': 'ã­', 'no': 'ã®',
            'ha': 'ã¯', 'hi': 'ã²', 'hu': 'ãµ', 'fu': 'ãµ', 'he': 'ã¸', 'ho': 'ã»',
            'ba': 'ã°', 'bi': 'ã³', 'bu': 'ã¶', 'be': 'ã¹', 'bo': 'ã¼',
            'pa': 'ã±', 'pi': 'ã´', 'pu': 'ã·', 'pe': 'ãº', 'po': 'ã½',
            'ma': 'ã¾', 'mi': 'ã¿', 'mu': 'ã‚€', 'me': 'ã‚', 'mo': 'ã‚‚',
            'ya': 'ã‚„', 'yu': 'ã‚†', 'yo': 'ã‚ˆ',
            'ra': 'ã‚‰', 'ri': 'ã‚Š', 'ru': 'ã‚‹', 're': 'ã‚Œ', 'ro': 'ã‚',
            'wa': 'ã‚', 'wi': 'ã‚', 'we': 'ã‚‘', 'wo': 'ã‚’',
            // æ‹—éŸ³
            'kya': 'ãã‚ƒ', 'kyu': 'ãã‚…', 'kyo': 'ãã‚‡',
            'gya': 'ãã‚ƒ', 'gyu': 'ãã‚…', 'gyo': 'ãã‚‡',
            'sha': 'ã—ã‚ƒ', 'shu': 'ã—ã‚…', 'sho': 'ã—ã‚‡', 'sya': 'ã—ã‚ƒ', 'syu': 'ã—ã‚…', 'syo': 'ã—ã‚‡',
            'ja': 'ã˜ã‚ƒ', 'ju': 'ã˜ã‚…', 'jo': 'ã˜ã‚‡',
            'cha': 'ã¡ã‚ƒ', 'chu': 'ã¡ã‚…', 'cho': 'ã¡ã‚‡',
            'tya': 'ã¡ã‚ƒ', 'tyu': 'ã¡ã‚…', 'tyo': 'ã¡ã‚‡',
            'dya': 'ã¢ã‚ƒ', 'dyu': 'ã¢ã‚…', 'dyo': 'ã¢ã‚‡',
            'nya': 'ã«ã‚ƒ', 'nyu': 'ã«ã‚…', 'nyo': 'ã«ã‚‡',
            'hya': 'ã²ã‚ƒ', 'hyu': 'ã²ã‚…', 'hyo': 'ã²ã‚‡',
            'bya': 'ã³ã‚ƒ', 'byu': 'ã³ã‚…', 'byo': 'ã³ã‚‡',
            'pya': 'ã´ã‚ƒ', 'pyu': 'ã´ã‚…', 'pyo': 'ã´ã‚‡',
            'mya': 'ã¿ã‚ƒ', 'myu': 'ã¿ã‚…', 'myo': 'ã¿ã‚‡',
            'rya': 'ã‚Šã‚ƒ', 'ryu': 'ã‚Šã‚…', 'ryo': 'ã‚Šã‚‡',
            'lya': 'ã‚Šã‚ƒ', 'lyu': 'ã‚Šã‚…', 'lyo': 'ã‚Šã‚‡'
        };
        
        // åˆ›å»ºè™šæ‹Ÿé”®ç›˜
        function createVirtualKeyboard() {
            if (virtualKeyboard) {
                virtualKeyboard.remove();
            }
            
            virtualKeyboard = document.createElement('div');
            virtualKeyboard.className = 'virtual-keyboard';
            virtualKeyboard.id = 'virtual-keyboard';
            
            virtualKeyboard.innerHTML = `
                <div class="keyboard-rows">
                     <div class="keyboard-row">
                         <div class="keyboard-key" data-key="q">q</div>
                         <div class="keyboard-key" data-key="w">w</div>
                         <div class="keyboard-key" data-key="e">e</div>
                         <div class="keyboard-key" data-key="r">r</div>
                         <div class="keyboard-key" data-key="t">t</div>
                         <div class="keyboard-key" data-key="y">y</div>
                         <div class="keyboard-key" data-key="u">u</div>
                         <div class="keyboard-key" data-key="i">i</div>
                         <div class="keyboard-key" data-key="o">o</div>
                         <div class="keyboard-key" data-key="p">p</div>
                     </div>
                     <div class="keyboard-row">
                         <div class="keyboard-key" data-key="a">a</div>
                         <div class="keyboard-key" data-key="s">s</div>
                         <div class="keyboard-key" data-key="d">d</div>
                         <div class="keyboard-key" data-key="f">f</div>
                         <div class="keyboard-key" data-key="g">g</div>
                         <div class="keyboard-key" data-key="h">h</div>
                         <div class="keyboard-key" data-key="j">j</div>
                         <div class="keyboard-key" data-key="k">k</div>
                         <div class="keyboard-key" data-key="l">l</div>
                     </div>
                     <div class="keyboard-row">
                         <div class="keyboard-key" data-key="z">z</div>
                         <div class="keyboard-key" data-key="x">x</div>
                         <div class="keyboard-key" data-key="c">c</div>
                         <div class="keyboard-key" data-key="v">v</div>
                         <div class="keyboard-key" data-key="b">b</div>
                         <div class="keyboard-key" data-key="n">n</div>
                         <div class="keyboard-key" data-key="m">m</div>
                     </div>
                     <div class="keyboard-row keyboard-row-function">
                         <div class="keyboard-key function-key submit-key" data-key="submit">æäº¤</div>
                         <div class="keyboard-key function-key backspace-key" data-key="backspace">é€€æ ¼</div>
                     </div>
                 </div>
            `;
            
            document.body.appendChild(virtualKeyboard);
            
            // æ·»åŠ é”®ç›˜æŒ‰é”®äº‹ä»¶
            virtualKeyboard.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢ç‚¹å‡»é”®ç›˜æ—¶å…³é—­é”®ç›˜
                handleKeyboardClick(e);
            });
            virtualKeyboard.addEventListener('touchend', (e) => {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦æ‘¸é”®ç›˜æ—¶å…³é—­é”®ç›˜
                handleKeyboardClick(e);
            });
            
            // é˜²æ­¢è§¦æ‘¸æ—¶çš„é»˜è®¤è¡Œä¸º
            virtualKeyboard.addEventListener('touchstart', function(e) {
                e.preventDefault();
            });
            
            // ä¸ºæ¯ä¸ªæŒ‰é”®æ·»åŠ è§¦æ‘¸ä¼˜åŒ–
            const keys = virtualKeyboard.querySelectorAll('.keyboard-key');
            keys.forEach(key => {
                key.style.userSelect = 'none';
                key.style.webkitUserSelect = 'none';
                key.style.webkitTouchCallout = 'none';
            });
        }
        
        // å¤„ç†é”®ç›˜ç‚¹å‡»
        function handleKeyboardClick(event) {
            event.preventDefault();
            event.stopPropagation();
            
            // è·å–è¢«ç‚¹å‡»çš„å…ƒç´ 
            let target = event.target;
            
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯é”®ç›˜æŒ‰é”®ï¼Œå°è¯•æ‰¾åˆ°æœ€è¿‘çš„é”®ç›˜æŒ‰é”®
            if (!target.hasAttribute('data-key')) {
                target = target.closest('.keyboard-key');
            }
            
            if (!target || !target.hasAttribute('data-key')) {
                console.log('æœªæ‰¾åˆ°æœ‰æ•ˆçš„é”®ç›˜æŒ‰é”®');
                return;
            }
            
            const key = target.getAttribute('data-key');
            console.log('æŒ‰é”®ç‚¹å‡»:', key);
            
            const input = document.getElementById('reading-input');
            if (!input) {
                console.log('æœªæ‰¾åˆ°è¾“å…¥æ¡†');
                return;
            }
            
            // æ·»åŠ è§†è§‰åé¦ˆå’Œè§¦æ‘¸åé¦ˆ
            target.style.background = '#007bff';
            target.style.color = 'white';
            target.style.transform = 'scale(0.95)';
            target.style.transition = 'all 0.1s ease';
            
            // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            setTimeout(() => {
                target.style.transform = 'scale(1)';
                if (target.classList.contains('function-key')) {
                    target.style.background = '';
                    target.style.color = '';
                } else {
                    target.style.background = 'white';
                    target.style.color = 'black';
                }
            }, 150);
            
            switch (key) {
                 case 'backspace':
                     if (currentRomajiInput.length > 0) {
                         // åˆ é™¤å½“å‰è¾“å…¥çš„ç½—é©¬å­—
                         currentRomajiInput = currentRomajiInput.slice(0, -1);
                     } else if (convertedText.length > 0) {
                         // åˆ é™¤å·²è½¬æ¢çš„å¹³å‡å
                         convertedText = convertedText.slice(0, -1);
                     }
                     updateInputDisplay();
                     break;
                     
                 case 'submit':
                     // å…ˆè½¬æ¢å‰©ä½™çš„ç½—é©¬å­—è¾“å…¥
                     if (currentRomajiInput) {
                         realTimeConvert();
                     }
                     // ç„¶åæäº¤ç­”æ¡ˆ
                     setTimeout(() => {
                         checkInputAnswer();
                     }, 100);
                     break;
                     
                 case 'next':
                     // ç‚¹å‡»ä¸‹ä¸€é¢˜æŒ‰é’®
                     nextQuestion();
                     break;
                     
                 default:
                     currentRomajiInput += key;
                     // å®æ—¶è½¬æ¢
                     realTimeConvert();
                     break;
             }
            
            updateRomajiPreview();
            input.focus();
        }
        
        // å®æ—¶è½¬æ¢ç½—é©¬å­—
        function realTimeConvert() {
            const input = document.getElementById('reading-input');
            if (!input) return;
            
            // å¦‚æœæ²¡æœ‰ç½—é©¬å­—è¾“å…¥ï¼Œç›´æ¥è¿”å›
            if (!currentRomajiInput) {
                updateInputDisplay();
                return;
            }
            
            let converted = '';
            let remaining = currentRomajiInput;
            
            // ä»æœ€é•¿çš„å¯èƒ½åŒ¹é…å¼€å§‹å°è¯•è½¬æ¢
            while (remaining.length > 0) {
                let found = false;
                
                // ç‰¹æ®Šå¤„ç†nï¼šåªæœ‰åœ¨ç‰¹å®šæƒ…å†µä¸‹æ‰è½¬æ¢ä¸ºã‚“
                if (remaining.startsWith('n')) {
                    // å¦‚æœæ˜¯nnï¼Œè½¬æ¢ä¸ºã‚“
                    if (remaining.startsWith('nn')) {
                        converted += 'ã‚“';
                        remaining = remaining.substring(2);
                        found = true;
                    }
                    // å¦‚æœnåé¢è·Ÿç€è¾…éŸ³ï¼ˆé™¤äº†yï¼‰ï¼Œè½¬æ¢ä¸ºã‚“
                    else if (remaining.length > 1) {
                        const nextChar = remaining.charAt(1);
                        if (nextChar && 'bcdfghjklmpqrstvwxz'.includes(nextChar) && nextChar !== 'y') {
                            converted += 'ã‚“';
                            remaining = remaining.substring(1);
                            found = true;
                        }
                    }
                }
                
                // å¦‚æœnæ²¡æœ‰è¢«ç‰¹æ®Šå¤„ç†ï¼Œå°è¯•æ­£å¸¸çš„ç½—é©¬å­—åŒ¹é…
                if (!found) {
                    // å°è¯•ä»æœ€é•¿åˆ°æœ€çŸ­çš„åŒ¹é…
                    for (let len = Math.min(remaining.length, 3); len > 0; len--) {
                        const substr = remaining.substring(0, len);
                        const hiragana = romajiToHiragana[substr];
                        
                        if (hiragana) {
                            converted += hiragana;
                            remaining = remaining.substring(len);
                            found = true;
                            break;
                        }
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯éƒ¨åˆ†è¾“å…¥
                if (!found) {
                    // æ£€æŸ¥å½“å‰è¾“å…¥æ˜¯å¦æ˜¯æŸä¸ªç½—é©¬å­—çš„å¼€å¤´
                    let isPartial = false;
                    for (const romaji in romajiToHiragana) {
                        if (romaji.startsWith(remaining)) {
                            isPartial = true;
                            break;
                        }
                    }
                    
                    if (isPartial) {
                        // æ˜¯éƒ¨åˆ†è¾“å…¥ï¼Œä¿ç•™ä¸è½¬æ¢
                        break;
                    } else {
                        // ä¸æ˜¯æœ‰æ•ˆè¾“å…¥ï¼Œè·³è¿‡ç¬¬ä¸€ä¸ªå­—ç¬¦
                        remaining = remaining.substring(1);
                    }
                }
            }
            
            // å¦‚æœæœ‰è½¬æ¢ç»“æœï¼Œæ›´æ–°å·²è½¬æ¢çš„éƒ¨åˆ†
            if (converted) {
                convertedText += converted;
                currentRomajiInput = remaining;
            }
            
            // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
            updateInputDisplay();
        }
        
        // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
        function updateInputDisplay() {
            const input = document.getElementById('reading-input');
            if (!input) return;
            
            // æ˜¾ç¤ºå·²è½¬æ¢çš„å¹³å‡å + å½“å‰è¾“å…¥çš„ç½—é©¬å­—
            input.value = convertedText + currentRomajiInput;
        }
        
        // è½¬æ¢å¹¶æ’å…¥å¹³å‡åï¼ˆä¿ç•™åŸå‡½æ•°ç”¨äºå…¶ä»–åœ°æ–¹ï¼‰
        function convertAndInsert() {
            const input = document.getElementById('reading-input');
            if (!input || !currentRomajiInput) return;
            
            // å°è¯•è½¬æ¢å½“å‰ç½—é©¬å­—è¾“å…¥
            let converted = convertRomajiToHiragana(currentRomajiInput);
            if (converted) {
                input.value += converted;
                currentRomajiInput = '';
            } else if (currentRomajiInput.length > 0) {
                // å¦‚æœæ— æ³•è½¬æ¢ï¼Œå°è¯•éƒ¨åˆ†è½¬æ¢
                let partialConverted = '';
                let remaining = currentRomajiInput;
                
                // ä»æœ€é•¿çš„å¯èƒ½åŒ¹é…å¼€å§‹å°è¯•
                for (let i = remaining.length; i > 0; i--) {
                    const substr = remaining.substring(0, i);
                    const hiragana = romajiToHiragana[substr];
                    if (hiragana) {
                        partialConverted += hiragana;
                        remaining = remaining.substring(i);
                        i = remaining.length + 1; // é‡æ–°å¼€å§‹
                    }
                }
                
                if (partialConverted) {
                    input.value += partialConverted;
                    currentRomajiInput = remaining;
                }
            }
        }
        
        // ç½—é©¬å­—è½¬å¹³å‡å
        function convertRomajiToHiragana(romaji) {
            // å…ˆå°è¯•å®Œæ•´åŒ¹é…
            if (romajiToHiragana[romaji]) {
                return romajiToHiragana[romaji];
            }
            
            // å°è¯•éƒ¨åˆ†åŒ¹é…ï¼ˆä»é•¿åˆ°çŸ­ï¼‰
            for (let i = romaji.length; i > 0; i--) {
                const substr = romaji.substring(0, i);
                if (romajiToHiragana[substr]) {
                    return romajiToHiragana[substr];
                }
            }
            
            return null;
        }
        
        // æ›´æ–°ç½—é©¬å­—é¢„è§ˆ
        function updateRomajiPreview() {
            const romajiText = document.getElementById('romaji-text');
            if (romajiText) {
                romajiText.textContent = currentRomajiInput || '(ç©º)';
                
                // æ˜¾ç¤ºå¯èƒ½çš„è½¬æ¢ç»“æœ
                const preview = document.getElementById('romaji-preview');
                if (currentRomajiInput) {
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥è½¬æ¢
                    const converted = convertRomajiToHiragana(currentRomajiInput);
                    if (converted) {
                        preview.innerHTML = `ç½—é©¬å­—: <span style="color: #666;">${currentRomajiInput}</span> â†’ <span style="color: #1565c0; font-weight: bold;">${converted}</span>`;
                    } else {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯éƒ¨åˆ†è¾“å…¥
                        let isPartial = false;
                        for (const romaji in romajiToHiragana) {
                            if (romaji.startsWith(currentRomajiInput)) {
                                isPartial = true;
                                break;
                            }
                        }
                        
                        if (isPartial) {
                            preview.innerHTML = `ç½—é©¬å­—: <span style="color: #666;">${currentRomajiInput}</span> <span style="color: #999;">(è¾“å…¥ä¸­...)</span>`;
                        } else {
                            preview.innerHTML = `ç½—é©¬å­—: <span style="color: #f44336;">${currentRomajiInput}</span> <span style="color: #f44336;">(æ— æ•ˆè¾“å…¥)</span>`;
                        }
                    }
                } else {
                    preview.innerHTML = 'ç½—é©¬å­—: <span style="color: #999;">(ç©º)</span>';
                }
            }
        }
        
        // æ˜¾ç¤º/éšè—è™šæ‹Ÿé”®ç›˜
        function toggleVirtualKeyboard() {
            if (isKeyboardVisible) {
                hideVirtualKeyboard();
            } else {
                showVirtualKeyboard();
            }
        }
        
        function showVirtualKeyboard() {
            if (virtualKeyboard) {
                virtualKeyboard.classList.add('show');
                isKeyboardVisible = true;
                
                // é‡ç½®è¾“å…¥çŠ¶æ€
                currentRomajiInput = '';
                convertedText = '';
                updateInputDisplay();
                updateRomajiPreview();
            }
        }
        
        function hideVirtualKeyboard() {
            if (virtualKeyboard) {
                virtualKeyboard.classList.remove('show');
                isKeyboardVisible = false;
                
                // è½¬æ¢å‰©ä½™çš„ç½—é©¬å­—è¾“å…¥
                if (currentRomajiInput) {
                    convertAndInsert();
                }
            }
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            loadKanjiData();
            initMobileOptimizations();
            
            // æ·»åŠ æœç´¢æ¡†ç„¦ç‚¹æ ·å¼
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('focus', function() {
                this.style.borderColor = '#667eea';
                this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
            });
            searchInput.addEventListener('blur', function() {
                this.style.borderColor = '#ddd';
                this.style.boxShadow = 'none';
            });
            
            // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç‚¹å‡»ç©ºç™½å¤„å…³é—­è™šæ‹Ÿé”®ç›˜
            document.addEventListener('click', function(e) {
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è¾“å…¥æ¡†æˆ–è™šæ‹Ÿé”®ç›˜
                const input = document.getElementById('reading-input');
                const keyboard = document.getElementById('virtual-keyboard');
                
                // å¦‚æœè™šæ‹Ÿé”®ç›˜å­˜åœ¨ä¸”å¯è§
                if (keyboard && isKeyboardVisible) {
                    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è¾“å…¥æ¡†ä¹Ÿä¸æ˜¯é”®ç›˜ï¼Œåˆ™å…³é—­é”®ç›˜
                    if (!input?.contains(e.target) && !keyboard.contains(e.target)) {
                        hideVirtualKeyboard();
                    }
                }
            });
        });
    </script>
</body>
</html>